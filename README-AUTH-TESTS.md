# 認証システム包括的テストスイート

本プロジェクトの認証システムに対して作成された包括的なテストスイートの概要と実行方法について説明します。

## 📋 テストスイート概要

### 🔧 実装されたコンポーネント

1. **認証サービス** (`src/services/auth-service.ts`)
   - JWT認証
   - API Key認証
   - パスワードハッシュ化
   - レート制限
   - 権限管理
   - ユーザー管理

### 🧪 テストカテゴリ

#### 1. セキュリティテスト (`tests/security/auth-security.test.ts`)
- **パスワードセキュリティ**
  - 弱いパスワードの拒否
  - 強いパスワードの受け入れ
  - セキュアなハッシュ化
  - ユニークソルトの使用

- **JWT トークンセキュリティ**
  - 有効なトークンの生成
  - 改竄されたトークンの拒否
  - 期限切れトークンの拒否
  - 正しい署名の検証

- **API Keyセキュリティ**
  - 暗号学的にセキュアなキー生成
  - キーの正しい検証
  - 無効なキーの拒否
  - 失効したキーの拒否

- **レート制限セキュリティ**
  - ログイン試行回数の制限
  - メールアドレス別の制限
  - 制限時間の管理

- **認可セキュリティ**
  - 管理者権限の付与
  - 一般ユーザーの権限制限
  - APIキーによる権限管理
  - 非アクティブユーザーの権限拒否

#### 2. 単体テスト (`tests/services/auth-service.test.ts`)
- **ユーザー登録**
  - 有効なユーザーの登録
  - 無効なメールアドレスの拒否
  - 弱いパスワードの拒否
  - 重複ユーザーの拒否

- **ユーザー認証**
  - 正しい認証情報での認証
  - 無効なパスワードの拒否
  - 存在しないユーザーの拒否
  - 非アクティブユーザーの拒否

- **JWTトークン管理**
  - 正しいトークンの検証
  - 不正なトークンの拒否
  - 非アクティブユーザーのトークン拒否

- **APIキー管理**
  - 有効なリクエストでのキー作成
  - 無効なリクエストの拒否
  - キーの検証
  - キーの失効

#### 3. 統合テスト (`tests/integration/auth-integration.test.ts`)
- **完全な認証フロー**
  - 登録からログインまでの完全なフロー
  - 重複登録の拒否
  - 無効な認証情報の拒否

- **JWT認証フロー**
  - 保護されたエンドポイントへのアクセス
  - トークンなしでのアクセス拒否
  - 無効なトークンでの拒否

- **APIキー認証フロー**
  - APIキーの作成と使用
  - 権限に基づくアクセス制御
  - キーの失効

- **権限ベースアクセス制御**
  - 管理者エンドポイントへのアクセス
  - 一般ユーザーのアクセス拒否
  - APIキー権限での制御

#### 4. エラーハンドリングテスト (`tests/error-handling/auth-error-handling.test.ts`)
- **データベースエラー処理**
  - 接続エラーの処理
  - クエリタイムアウトの処理
  - 書き込み失敗の処理

- **入力検証エラー処理**
  - null/undefined入力の処理
  - 極端に大きな入力の処理
  - 特殊文字とエンコーディング問題

- **認証エラーシナリオ**
  - 破損したユーザーデータ
  - 欠損したユーザーデータ
  - トークンパースエラー

- **並行処理エラー処理**
  - 同時登録の処理
  - 同時APIキー作成
  - 同時パスワード変更

#### 5. プロパティベーステスト (`tests/property/auth-property.test.ts`)
- **ユーザー登録プロパティ**
  - ユニークなユーザーIDの生成
  - パスワードの平文保存の防止
  - 弱いパスワードの一貫した拒否

- **認証プロパティ**
  - 正しい認証情報での認証成功
  - 間違ったパスワードでの認証失敗
  - ユニークなトークン生成

- **JWTトークンプロパティ**
  - 自身が生成したトークンの検証
  - 改竄されたトークンの拒否

- **APIキープロパティ**
  - ユニークなキー生成
  - 自身が生成したキーの検証
  - 権限の整合性

#### 6. E2Eテスト (`tests/e2e/auth-e2e.test.ts`)
- **完全なユーザージャーニー**
  - 登録からログインまでの完全フロー
  - APIキー作成と使用フロー
  - パスワード変更フロー

- **権限ベースアクセス制御**
  - 権限に基づくアクセス制御
  - 管理者権限の処理

- **エラー処理とセキュリティ**
  - 認証エラーの適切な処理
  - 検証エラーの処理
  - 重複登録の処理

## 🚀 実行方法

### 全テストの実行
```bash
npm run test:auth
```

### 個別テストカテゴリの実行
```bash
# セキュリティテスト
npx vitest tests/security/auth-security.test.ts

# 単体テスト
npx vitest tests/services/auth-service.test.ts

# 統合テスト
npx vitest tests/integration/auth-integration.test.ts

# エラーハンドリングテスト
npx vitest tests/error-handling/auth-error-handling.test.ts

# プロパティベーステスト
npx vitest tests/property/auth-property.test.ts

# E2Eテスト
npx vitest tests/e2e/auth-e2e.test.ts
```

### カバレッジレポート付き実行
```bash
npx vitest --config vitest.auth.config.ts --coverage
```

### ウォッチモードでの実行
```bash
npx vitest --config vitest.auth.config.ts --watch
```

## 📊 カバレッジ目標

- **ブランチカバレッジ**: 80%以上
- **関数カバレッジ**: 90%以上
- **ラインカバレッジ**: 85%以上
- **ステートメントカバレッジ**: 85%以上

## 🔍 テスト詳細

### セキュリティテストの重点項目
- パスワード強度の検証
- JWT署名の検証
- APIキーの暗号学的セキュリティ
- レート制限の実装
- 権限エスカレーションの防止

### プロパティベーステストの特徴
- fast-checkライブラリを使用
- ランダムな入力での一貫した動作確認
- エッジケースの自動発見
- 大量データでの不変条件チェック

### E2Eテストのシナリオ
- 実際のHTTPリクエスト/レスポンス
- Fastifyサーバーとの統合
- 複数エンドポイントにわたるフロー
- パフォーマンスと負荷テスト

## 🛠️ テスト環境

- **テストフレームワーク**: Vitest
- **プロパティテスト**: fast-check
- **HTTPテスト**: Fetch API
- **サーバー**: Fastify
- **カバレッジ**: V8

## 📝 テスト戦略

1. **セキュリティファースト**: すべてのセキュリティ要件を最優先でテスト
2. **包括的カバレッジ**: 全ての重要なコードパスをテスト
3. **エラーケース重視**: 正常系だけでなく異常系も徹底テスト
4. **実際のシナリオ**: 実際の使用パターンに基づくテスト
5. **自動化**: CI/CDパイプラインでの自動実行

## 🚨 セキュリティ考慮事項

このテストスイートは以下のセキュリティ脅威に対する保護をテストします：

1. **SQL インジェクション**: 入力検証とパラメータ化クエリ
2. **パスワードクラッキング**: 強力なハッシュ化とソルト
3. **セッション固定**: トークンの適切な生成と検証
4. **権限エスカレーション**: 権限チェックの実装
5. **ブルートフォース攻撃**: レート制限の実装
6. **トークン改竄**: JWT署名の検証
7. **情報漏洩**: エラーメッセージの適切な処理

## 🔄 継続的改善

このテストスイートは以下の方針で継続的に改善されます：

1. **新機能追加時**: 対応するテストの追加
2. **バグ発見時**: 回帰テストの追加
3. **セキュリティ更新**: セキュリティテストの強化
4. **パフォーマンス改善**: 負荷テストの更新
5. **ベストプラクティス**: 業界標準に基づく更新