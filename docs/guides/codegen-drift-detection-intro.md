# コード生成ドリフト検出 入門ガイド

> 🌍 Language / 言語: 日本語 | English

---

## English (Overview)

Intro to codegen drift detection: compare generated code against IR/templates to detect divergence, surface a clear yes/no signal, and wire into CI. Includes where logic lives, how to run, thresholds, and customization flags.

このドキュメントでは、ae-frameworkにおける「コード生成ドリフト検出」の仕組みや使い方について、プログラミングやCI/CDに不慣れな方でも分かるようにやさしく解説します。

---

## 1. コード生成ドリフト検出とは？

- **自動生成コード**：設計ファイルやテンプレートをもとに、自動的に作られるプログラムのことです。
- **ドリフト検出**：自動生成されたコードが、元の設計やテンプレートから“ズレていないか”を自動でチェックする仕組みです。

---
### イメージ例

- **レシピ（設計・仕様）** と **料理の写真（生成コード）** を毎回比べて、「ちゃんとレシピ通りに作られている？」とロボットが自動でチェックしてくれるイメージです。

---

## 2. ドリフト検出の仕組み

ae-frameworkでは、以下の流れでドリフト検出が行われます。

1. **設計ファイル（例：.ae/ae-ir.json）** と **生成されたコード** を比較します。
2. **ズレ（ドリフト）がなければ、「Regeneration needed: No」と表示**され、問題ない状態です。
3. **ズレが発生していれば、「Regeneration needed: Yes」と表示**され、再生成や修正が推奨されます。

---

## 3. どのファイルで判定しているの？

主に以下のファイル・スクリプトでドリフト検出が行われます。

- `src/codegen/drift-detector.ts`  
  ドリフト検出のロジック本体。  
- `src/cli/codegen-cli.ts`  
  コマンドラインからドリフト検出を実行するためのCLIツール。  
- `scripts/codegen-tools.sh`  
  コード生成やドリフト検出を自動化するためのシェルスクリプト。

---

## 4. どんな基準で「No」や「Yes」を判定しているの？

- **No（正常）**  
  → 設計ファイルやテンプレートと生成されたコードが一致している、または許容範囲内の違いだけ。
- **Yes（ドリフト発生）**  
  → 生成されたコードが設計ファイルやテンプレートと大きく違っていて、手動修正や仕様変更があった可能性がある。

---

## 5. カスタマイズはできる？

はい、カスタマイズできます！

- コマンド実行時のオプション（`--ignore`, `--auto-fix` など）で挙動を変えられます。
- たとえば「特定のフォルダは無視したい」「軽微なズレは自動で直したい」といった指定が可能です。

### コマンド例

```bash
npx tsx src/cli/index.ts codegen drift \
  --code-dir generated \
  --spec .ae/ae-ir.json \
  --ignore "dist/**" "node_modules/**" \
  --auto-fix
```

---

## 6. CI/CDってなに？どう関係するの？

- **CI/CD**は「プログラムのテストやチェック、リリースを自動でやってくれる仕組み」です。
- ドリフト検出も、CI/CDの仕組みに組み込むことで、**プログラムをアップロードするたびに自動でチェック**が走るようになります。
- 手動でもコマンドで実行できますし、自動化もできます。

---

## 7. まとめ

- 「ドリフト検出」は、自動生成コードが設計からズレていないか自動で調べる便利な仕組みです。
- ズレがなければ「No」、あれば「Yes」と分かりやすく判定してくれます。
- コマンドのオプションやソースコードを書き換えることで、自分のプロジェクトに合わせてカスタマイズできます。
- CI/CDを使えば、チェックを自動化できて安心です。

---

### もっと知りたい場合

- 具体的なカスタマイズ例やコマンドの使い方は、`src/codegen/drift-detector.ts`や`src/cli/codegen-cli.ts`のコメント、または`scripts/codegen-tools.sh`を見てみましょう。
- 分からないことは、チームメンバーや詳しい人に気軽に質問してください！
