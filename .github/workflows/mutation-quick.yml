name: Mutation Quick

on:
  workflow_dispatch:
    inputs:
      mutate:
        description: "追加で --mutate に渡す glob (optional)"
        required: false
      time_limit:
        description: "STRYKER_TIME_LIMIT (秒) を上書き"
        required: false
      base_ref:
        description: "auto-diff 用の比較ブランチ (default: origin/main)"
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  mutation-quick:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      EXTRA_MUTATE: ${{ inputs.mutate }}
      EXTRA_TIME_LIMIT: ${{ inputs.time_limit }}
      AUTO_DIFF_BASE: ${{ inputs.base_ref }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch base for auto-diff
        if: ${{ env.AUTO_DIFF_BASE == '' }}
        run: git fetch --no-tags --depth=1 origin main

      - name: Fetch custom base
        if: ${{ env.AUTO_DIFF_BASE != '' }}
        run: |
          git fetch --no-tags --depth=1 origin "${AUTO_DIFF_BASE}"

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

      - name: Prepare mutation arguments
        id: mutation-args
        run: |
          set -euo pipefail
          args=()
          if [ -n "${EXTRA_MUTATE}" ]; then
            args+=("--mutate")
            args+=("${EXTRA_MUTATE}")
          fi
          if [ -n "${EXTRA_TIME_LIMIT}" ]; then
            echo "STRYKER_TIME_LIMIT=${EXTRA_TIME_LIMIT}" >> "$GITHUB_ENV"
          fi
          target_base=${AUTO_DIFF_BASE:-}
          if [ -z "$target_base" ]; then
            target_base='origin/main'
          fi
          echo "base_ref=$target_base" >> "$GITHUB_OUTPUT"
          {
            echo 'args<<__MUT_ARGS__'
            if [ "${#args[@]}" -gt 0 ]; then
              printf '%s\n' "${args[@]}"
            fi
            echo '__MUT_ARGS__'
          } >> "$GITHUB_OUTPUT"

      - name: Run mutation auto diff
        id: mutation
        uses: ./.github/actions/mutation-auto-diff
        with:
          base-ref: ${{ steps.mutation-args.outputs.base_ref }}
          quick: 'true'
          extra-args: ${{ steps.mutation-args.outputs.args }}

      - name: Append mutation auto diff summary
        if: ${{ always() }}
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## Mutation auto diff
          - Base ref: `${{ steps.mutation-args.outputs.base_ref }}`
          - Mutation score: `${{ steps.mutation.outputs['mutation-score'] }}`
          - Detected / Undetected: `${{ steps.mutation.outputs.detected }}` / `${{ steps.mutation.outputs.undetected }}`
          - Survived: `${{ steps.mutation.outputs.survived }}` (No coverage: `${{ steps.mutation.outputs['no-coverage'] }}`)
          - Timeouts: `${{ steps.mutation.outputs.timeout }}` / Compile errors: `${{ steps.mutation.outputs['compile-errors'] }}`
          EOF

      - name: Mutation quick summary
        if: ${{ always() }}
        run: |
          pnpm mutation:report || {
            printf 'Mutation report unavailable.\n' >> "$GITHUB_STEP_SUMMARY"
            exit 0
          }

      - name: Mutation survivors JSON
        if: ${{ always() }}
        run: |
          if [ -f reports/mutation/mutation.json ]; then
            node scripts/mutation/list-survivors.mjs --limit 50 > reports/mutation/survivors.json
            survivors_for_summary="$(node scripts/mutation/list-survivors.mjs --limit 10)"
            {
              printf '%s\n' '## Mutation survivors (top 10)'
              printf '%s\n' '```json'
              printf '%s\n' "$survivors_for_summary"
              printf '%s\n' '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            printf "%s\n" "No mutation report found; skipped survivors extraction." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload mutation survivors
        if: ${{ always() && hashFiles('reports/mutation/survivors.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: mutation-survivors-json
          path: reports/mutation/survivors.json
