name: pr-summary-comment
on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  pull-requests: write
jobs:
  label:
    if: github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const pr = context.payload.pull_request;
            if (!pr) return;
            const toAdd = new Set();
            // trace:<id>
            const m = (pr.title||'').match(/trace:([A-Za-z0-9_.:-]+)/);
            if (m) toAdd.add(`trace:${m[1]}`);
            // detailed
            if ((pr.title||'').includes('[detailed]') || (pr.body||'').includes('[detailed]')) toAdd.add('pr-summary:detailed');
            // coverage
            if ((pr.title||'').includes('[enforce-coverage]') || (pr.body||'').includes('[enforce-coverage]')) toAdd.add('enforce-coverage');
            const m2 = (pr.title||'').match(/\[cov=(\d{2,3})\]/) || (pr.body||'').match(/\[cov=(\d{2,3})\]/);
            if (m2) toAdd.add(`coverage:${m2[1]}`);
            // language
            const m3 = (pr.title||'').match(/\[lang=(ja|en)\]/i) || (pr.body||'').match(/\[lang=(ja|en)\]/i);
            if (m3) toAdd.add(`lang:${m3[1].toLowerCase()}`);
            if (toAdd.size) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: Array.from(toAdd) });
            }
  summarize:
    if: ${{ !github.event.pull_request.head.repo.fork && github.event.action != 'edited' }}
    runs-on: ubuntu-latest
    steps:
      - name: Determine summary language
        id: lang
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            const ja = labels.includes('lang:ja');
            core.setOutput('lang', ja ? 'ja' : 'en');
      - name: Determine summary mode
        id: mode
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            const detailed = labels.includes('pr-summary:detailed');
            core.setOutput('mode', detailed ? 'detailed' : 'digest');
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Aggregate artifacts if present
        run: |
          if npm run -s | grep -q "artifacts:aggregate"; then npm run artifacts:aggregate || true; fi
      - name: Generate Markdown summary
        id: gen
        env:
          SUMMARY_MODE: ${{ steps.mode.outputs.mode }}
          SUMMARY_LANG: ${{ steps.lang.outputs.lang }}
        run: |
          if [ -f scripts/summary/render-pr-summary.mjs ]; then node scripts/summary/render-pr-summary.mjs; else printf "No renderer; keeping inline\n"; fi
          node <<'JS'
          const fs=require("fs");
          function r(p){ try { return JSON.parse(fs.readFileSync(p,"utf-8")); } catch { return undefined; } }
          const c = r("artifacts/summary/combined.json") || {};
          const adapters=(c.adapters||[]).map(a=>`  - ${a.adapter||a.name}: ${a.summary} (${a.status})`).join("\n");
          const formalObj = c.formal || r("formal/summary.json") || {};
          const formal = formalObj.result || "n/a";
          const replay = c.replay || r("artifacts/domain/replay.summary.json") || {};
          const props = c.properties ? (Array.isArray(c.properties) ? c.properties : [c.properties]) : (r("artifacts/properties/summary.json") ? [r("artifacts/properties/summary.json")] : []);
          const traceIds = new Set();
          for (const a of c.adapters||[]) if (a?.traceId) traceIds.add(a.traceId);
          if (formalObj?.traceId) traceIds.add(formalObj.traceId);
          if (replay?.traceId) traceIds.add(replay.traceId);
          for (const p of props) if (p?.traceId) traceIds.add(p.traceId);
          const replayLine = replay.totalEvents!==undefined ? `Replay: ${replay.totalEvents} events, ${(replay.violatedInvariants||[]).length} violations` : "Replay: n/a";
          const md = `## Quality Summary\n- Adapters:\n${adapters}\n- Formal: ${formal}\n- ${replayLine}\n- Trace IDs: ${Array.from(traceIds).join(", ")}`;
          fs.mkdirSync("artifacts/summary",{recursive:true});
          fs.writeFileSync("artifacts/summary/PR_SUMMARY.md", md);
          console.log(md);
          JS
      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('artifacts/summary/PR_SUMMARY.md','utf-8');
            const header = '<!-- AE-PR-SUMMARY -->\n' + body;
            const { owner, repo, number } = context.issue;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: number, per_page: 100 });
            const mine = comments.data.find(c => c.body && c.body.startsWith('<!-- AE-PR-SUMMARY -->'));
            if (mine) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: mine.id, body: header });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body: header });
            }
      - name: Write job summary
        run: cat artifacts/summary/PR_SUMMARY.md >> "$GITHUB_STEP_SUMMARY"
