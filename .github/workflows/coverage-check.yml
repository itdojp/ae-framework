name: coverage-check
on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  workflow_dispatch:
    inputs:
      strict:
        description: 'Force strict coverage enforcement'
        required: false
        type: boolean
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  pull-requests: read
jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      strict: ${{ steps.gate.outputs.strict }}
      threshold: ${{ steps.th.outputs.threshold }}
    steps:
      - uses: actions/github-script@v7
        id: gate
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            let strict = labels.includes('enforce-coverage');
            const strictInputRaw = context.payload.inputs?.strict;
            const strictInput = typeof strictInputRaw === 'string'
              ? strictInputRaw.toLowerCase() === 'true'
              : Boolean(strictInputRaw);
            // Enforce on main if repo variable COVERAGE_ENFORCE_MAIN == '1'
            const onMainPush = context.eventName === 'push' && context.ref === 'refs/heads/main';
            const enforceMain = (process.env.COVERAGE_ENFORCE_MAIN || '0') === '1';
            if (onMainPush && enforceMain) strict = true;
            if (context.eventName === 'workflow_dispatch' && strictInput) strict = true;
            core.setOutput('strict', String(strict));
        env:
          COVERAGE_ENFORCE_MAIN: ${{ vars.COVERAGE_ENFORCE_MAIN }}
      - uses: actions/github-script@v7
        id: th
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            const cov = labels.find(n => n.startsWith('coverage:'));
            const def = Number(process.env.COVERAGE_DEFAULT_THRESHOLD || 80);
            const val = cov ? Number(cov.split(':')[1]) : def;
            core.setOutput('threshold', String(isFinite(val) ? val : def));
        env:
          COVERAGE_DEFAULT_THRESHOLD: ${{ vars.COVERAGE_DEFAULT_THRESHOLD }}
  coverage:
    needs: gate
    runs-on: ubuntu-latest
    steps:
      - name: Note
        run: |
          printf "%s\n" "Coverage policy:" \
          && printf "%s\n" "- Enforce on main: ${COVERAGE_ENFORCE_MAIN:-0}" \
          && printf "%s\n" "- Default threshold: ${COVERAGE_DEFAULT_THRESHOLD:-80} (override via coverage:<pct>)" \
          && printf "%s\n" "- Derived: label > repo var > default" \
          && printf "%s\n" "- Effective threshold: ${{ needs.gate.outputs.threshold }}%" \
          && printf "%s\n" "- Policy: ${{ needs.gate.outputs.strict == 'true' && 'enforced' || 'report-only' }}" \
          && printf "%s\n" "Dev toggles (optional):" \
          && printf "%s\n" "- AE_COVERAGE_DRY_RUN=${AE_COVERAGE_DRY_RUN:-0}" \
          && printf "%s\n" "- AE_COVERAGE_SKIP_COMMENT=${AE_COVERAGE_SKIP_COMMENT:-0}" \
          && printf "%s\n" "- AE_COVERAGE_SUMMARY_PATH=${AE_COVERAGE_SUMMARY_PATH:-}" 
        env:
          COVERAGE_ENFORCE_MAIN: ${{ vars.COVERAGE_ENFORCE_MAIN }}
          COVERAGE_DEFAULT_THRESHOLD: ${{ vars.COVERAGE_DEFAULT_THRESHOLD }}
          AE_COVERAGE_DRY_RUN: ${{ env.AE_COVERAGE_DRY_RUN }}
          AE_COVERAGE_SKIP_COMMENT: ${{ env.AE_COVERAGE_SKIP_COMMENT }}
          AE_COVERAGE_SUMMARY_PATH: ${{ env.AE_COVERAGE_SUMMARY_PATH }}
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Install deps (pnpm)
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Run coverage
        env:
          COVERAGE_STRICT: ${{ needs.gate.outputs.strict }}
        run: |
          if [ "${COVERAGE_STRICT}" = "true" ]; then
            pnpm run coverage
          else
            pnpm run coverage || true
          fi
      - name: Coverage artifact diagnostics
        if: always()
        run: |
          if [ -d coverage ]; then
            printf "%s\n" "coverage/ directory found"
            find coverage -maxdepth 2 -type f | sort
          else
            printf "%s\n" "coverage/ directory is missing"
          fi
          if [ -d artifacts/coverage ]; then
            printf "%s\n" "artifacts/coverage directory found"
            find artifacts/coverage -maxdepth 2 -type f | sort
          else
            printf "%s\n" "artifacts/coverage directory is missing"
          fi
          {
            printf "%s\n" "### Coverage Artifacts"
            if [ -d coverage ]; then
              printf "%s\n" "- coverage/ exists"
              find coverage -maxdepth 2 -type f | sort | sed 's/^/- /'
            else
              printf "%s\n" "- coverage/ is missing"
            fi
            if [ -d artifacts/coverage ]; then
              printf "%s\n" "- artifacts/coverage exists"
              find artifacts/coverage -maxdepth 2 -type f | sort | sed 's/^/- /'
            else
              printf "%s\n" "- artifacts/coverage is missing"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          if [ ! -d coverage ] && [ ! -d artifacts/coverage ]; then
            printf "%s\n" "No coverage artifact directories found."
          fi
      - name: Check coverage threshold
        env:
          THRESHOLD: ${{ needs.gate.outputs.threshold }}
          COVERAGE_STRICT: ${{ needs.gate.outputs.strict }}
        run: |
          SUMMARY_PATH=""
          if [ -f coverage/coverage-summary.json ]; then
            SUMMARY_PATH="coverage/coverage-summary.json"
          elif [ -f artifacts/coverage/coverage-summary.json ]; then
            SUMMARY_PATH="artifacts/coverage/coverage-summary.json"
          fi
          if [ -n "$SUMMARY_PATH" ]; then
            PCT=$(node - "$SUMMARY_PATH" <<'NODE'
            const fs = require('node:fs');
            const summaryPath = process.argv[2];
            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
            const pct = Number(summary?.total?.lines?.pct ?? 0);
            process.stdout.write(String(Number.isFinite(pct) ? pct : 0));
            NODE
            )
            printf "Coverage: %s%% (threshold: %s%%)\n" "$PCT" "$THRESHOLD"
            printf "Coverage summary source: %s\n" "$SUMMARY_PATH"
            {
              printf "%s\n" "### Coverage Threshold Check"
              printf "%s\n" "- summary: $SUMMARY_PATH"
              printf "%s\n" "- lines: $PCT%"
              printf "%s\n" "- threshold: $THRESHOLD%"
            } >> "$GITHUB_STEP_SUMMARY"
            awk 'BEGIN{ if ('"${PCT}"' + 0 < '"${THRESHOLD}"' + 0) exit 1 }' || {
              printf "%s\n" "::error::Coverage ${PCT}% below threshold ${THRESHOLD}% (see docs/quality/coverage-required.md; tips: /coverage <pct>, /enforce-coverage)"
              exit 1
            }
          else
            if [ "${COVERAGE_STRICT}" = "true" ]; then
              printf "%s\n" "::error::coverage summary JSON is missing under strict policy; expected coverage/coverage-summary.json (or artifacts/coverage/coverage-summary.json)"
              {
                printf "%s\n" "### Coverage Threshold Check"
                printf "%s\n" "- summary: missing"
                printf "%s\n" "- strict policy: true"
                printf "%s\n" "- expected: coverage/coverage-summary.json or artifacts/coverage/coverage-summary.json"
                printf "%s\n" "- hint: ensure \`pnpm run coverage\` emits \`json-summary\` reporter output"
              } >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi
            printf "%s\n" "No coverage summary JSON found; skipping check (looked in coverage/coverage-summary.json and artifacts/coverage/coverage-summary.json)"
          fi
        continue-on-error: ${{ needs.gate.outputs.strict != 'true' }}
      - name: Comment PR with coverage (non-blocking)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE_ENFORCE_MAIN: ${{ vars.COVERAGE_ENFORCE_MAIN }}
          COVERAGE_DEFAULT_THRESHOLD: ${{ vars.COVERAGE_DEFAULT_THRESHOLD }}
          AE_COVERAGE_DRY_RUN: ${{ env.AE_COVERAGE_DRY_RUN }}
          AE_COVERAGE_SKIP_COMMENT: ${{ env.AE_COVERAGE_SKIP_COMMENT }}
          AE_COVERAGE_SUMMARY_PATH: ${{ env.AE_COVERAGE_SUMMARY_PATH }}
        run: node scripts/coverage/pr-coverage-summary.mjs
