name: coverage-check
on:
  pull_request:
  push:
    branches: [ main ]
permissions:
  contents: read
jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      strict: ${{ steps.gate.outputs.strict }}
      threshold: ${{ steps.th.outputs.threshold }}
    steps:
      - uses: actions/github-script@v7
        id: gate
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            let strict = labels.includes('enforce-coverage');
            // Enforce on main if repo variable COVERAGE_ENFORCE_MAIN == '1'
            const onMainPush = context.eventName === 'push' && context.ref === 'refs/heads/main';
            const enforceMain = (process.env.COVERAGE_ENFORCE_MAIN || '0') === '1';
            if (onMainPush && enforceMain) strict = true;
            core.setOutput('strict', String(strict));
        env:
          COVERAGE_ENFORCE_MAIN: ${{ vars.COVERAGE_ENFORCE_MAIN }}
      - uses: actions/github-script@v7
        id: th
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            const cov = labels.find(n => n.startsWith('coverage:'));
            const def = Number(process.env.COVERAGE_DEFAULT_THRESHOLD || 80);
            const val = cov ? Number(cov.split(':')[1]) : def;
            core.setOutput('threshold', String(isFinite(val) ? val : def));
        env:
          COVERAGE_DEFAULT_THRESHOLD: ${{ vars.COVERAGE_DEFAULT_THRESHOLD }}
  coverage:
    needs: gate
    runs-on: ubuntu-latest
    steps:
      - name: Note
        run: |
          printf "%s\n" "Coverage dry-run on main is non-blocking by default."
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Enable corepack
        run: corepack enable
      - name: Install deps (pnpm)
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Run coverage
        run: pnpm run coverage || true
      - name: Check coverage threshold
        env:
          THRESHOLD: ${{ needs.gate.outputs.threshold }}
        run: |
          if [ -f coverage/coverage-summary.json ]; then \
            PCT=$(node -e "console.log((require('./coverage/coverage-summary.json').total.lines.pct)||0)"); \
            printf "Coverage: %s%% (threshold: %s%%)\n" "$PCT" "$THRESHOLD"; \
            awk 'BEGIN{ if ('"${PCT}"' + 0 < '"${THRESHOLD}"' + 0) exit 1 }'; \
          else \
            printf "%s\n" "No coverage-summary.json found; skipping check"; \
          fi
        continue-on-error: ${{ needs.gate.outputs.strict != 'true' }}
      - name: Comment PR with coverage (non-blocking)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryPath = 'coverage/coverage-summary.json';
            if (!fs.existsSync(summaryPath)) return;
            const cov = JSON.parse(fs.readFileSync(summaryPath,'utf-8'));
            const pct = cov?.total?.lines?.pct ?? 'n/a';
            const header = '<!-- AE-COVERAGE-SUMMARY -->\n';
            const body = header + `Coverage (lines): ${pct}%\nThreshold: ${{ needs.gate.outputs.threshold }}%\nPolicy: ${{ needs.gate.outputs.strict == 'true' ? 'enforced' : 'report-only' }}`;
            const { owner, repo, number } = context.issue;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: number, per_page: 100 });
            const mine = comments.data.find(c => c.body && c.body.startsWith(header));
            if (mine) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: mine.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body });
            }
