name: Minimal Pipeline Demo

on:
  workflow_dispatch:
    inputs:
      enforce_lint:
        description: "Run verify:lite with lint enforcement (may produce warnings)"
        required: false
        default: "false"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  minimal-pipeline:
    runs-on: ubuntu-latest
    env:
      AE_HOST_STORE: ${{ github.workspace }}/.pnpm-store
      PNPM_STORE_PATH: ${{ github.workspace }}/.pnpm-store
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: 22
      - name: Ensure pnpm cache dir
        run: mkdir -p "$AE_HOST_STORE"
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.AE_HOST_STORE }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Install dependencies
        run: |
          pnpm fetch --prefer-offline
          pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile --prefer-offline
      - name: Run CodeX quickstart (skip quality, run formal stub)
        env:
          CODEX_SKIP_QUALITY: "1"
          CODEX_RUN_FORMAL: "1"
          CODEX_TOLERANT: "1"
        run: pnpm run codex:quickstart
      - name: Unit tests (EnhancedStateManager focus)
        run: pnpm vitest run tests/unit/utils/enhanced-state-manager.test.ts tests/unit/utils/enhanced-state-manager.rollback.test.ts --reporter dot
      - name: Property tests (KvOnce PoC)
        run: pnpm vitest run tests/property/kvonce.safety.property.test.ts --reporter dot
      - name: Verify Lite (script)
        env:
          VERIFY_LITE_KEEP_LINT_LOG: '1'
          VERIFY_LITE_RUN_MUTATION: '0'
          VERIFY_LITE_ENFORCE_LINT: ${{ github.event.inputs.enforce_lint == 'true' && '1' || '0' }}
          VERIFY_LITE_SUMMARY_FILE: verify-lite-run-summary.json
          VERIFY_LITE_SUMMARY_EXPORT_PATH: artifacts/verify-lite/verify-lite-run-summary.json
          VERIFY_LITE_LINT_BASELINE: config/verify-lite-lint-baseline.json
        run: pnpm run verify:lite
      - name: Validate verify-lite summary schema
        if: always()
        run: |
          if [ -f verify-lite-run-summary.json ]; then
            node scripts/ci/validate-verify-lite-summary.mjs \
              verify-lite-run-summary.json \
              schema/verify-lite-run-summary.schema.json
          else
            echo 'verify-lite summary missing; skipped validation'
          fi
      - name: Validate flow/envelope fixtures
        if: always()
        run: node scripts/ci/validate-json.mjs
      - name: Create verify-lite report envelope
        if: always()
        env:
          REPORT_ENVELOPE_SOURCE: verify-lite
        run: |
          if [ -f artifacts/verify-lite/verify-lite-run-summary.json ]; then
            node scripts/trace/create-report-envelope.mjs \
              artifacts/verify-lite/verify-lite-run-summary.json \
              artifacts/report-envelope.json
          elif [ -f verify-lite-run-summary.json ]; then
            node scripts/trace/create-report-envelope.mjs \
              verify-lite-run-summary.json \
              artifacts/report-envelope.json
          else
            echo 'verify-lite summary missing; skipped envelope generation'
          fi
      - name: Validate report envelope schema
        if: always()
        run: |
          node scripts/ci/validate-report-envelope.mjs \
            artifacts/report-envelope.json \
            schema/envelope.schema.json
      - name: Upload verify-lite artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verify-lite-report
          path: |
            artifacts/verify-lite/verify-lite-run-summary.json
            artifacts/report-envelope.json
            verify-lite-run-summary.json
            verify-lite-lint.log
            verify-lite-lint-summary.json
      - name: Summarize lint findings
        if: always()
        run: |
          if [ -f verify-lite-lint-summary.json ]; then
            echo "## Verify Lite Lint Summary" >> "$GITHUB_STEP_SUMMARY"
            node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('verify-lite-lint-summary.json','utf8')); console.log('Total issues:', data.total); console.log('Top rules:'); data.rules.slice(0,5).forEach(r=>console.log('-', r.rule, r.count));" | tee -a "$GITHUB_STEP_SUMMARY"
          else
            echo "No lint summary generated" >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Verify lite lint baseline
        if: always()
        env:
          VERIFY_LITE_LINT_ENFORCE: ${{ github.event.inputs.enforce_lint == 'true' && '1' || '0' }}
        run: |
          if [ -f verify-lite-lint-summary.json ]; then
            set -o pipefail
            node scripts/ci/enforce-verify-lite-lint.mjs \
              verify-lite-lint-summary.json \
              config/verify-lite-lint-baseline.json | tee /tmp/lint-baseline-report.txt
            cat /tmp/lint-baseline-report.txt >> "$GITHUB_STEP_SUMMARY"
          else
            echo 'verify-lite lint summary missing; skipped baseline enforcement' | tee -a "$GITHUB_STEP_SUMMARY"
          fi
      - name: Append verify-lite run summary
        if: always()
        run: |
          if [ -f verify-lite-run-summary.json ]; then
            echo '## Verify Lite Run Summary' >> "$GITHUB_STEP_SUMMARY"
            node scripts/ci/render-verify-lite-summary.mjs verify-lite-run-summary.json >> "$GITHUB_STEP_SUMMARY"
          else
            echo 'Verify Lite run summary not generated.' >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: KvOnce TLC (informational)
        run: |
          pnpm run spec:kv-once:tlc
          if [ -f hermetic-reports/formal/tla-summary.json ]; then
            cp hermetic-reports/formal/tla-summary.json hermetic-reports/formal/kvonce-tlc-summary.json
          fi
      - name: KvOnce Apalache (informational)
        run: |
          pnpm run spec:kv-once:apalache
          if [ -f hermetic-reports/formal/tla-summary.json ]; then
            cp hermetic-reports/formal/tla-summary.json hermetic-reports/formal/kvonce-apalache-summary.json
            rm -f hermetic-reports/formal/tla-summary.json
          fi
      - name: Upload formal summary (legacy path)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-tla-summary
          path: hermetic-reports/formal/tla-summary.json
          if-no-files-found: ignore
      - name: Upload KvOnce summaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-kvonce-summaries
          path: |
            hermetic-reports/formal/kvonce-tlc-summary.json
            hermetic-reports/formal/kvonce-apalache-summary.json
          if-no-files-found: ignore
