name: CI Extended

on:
  workflow_call:
    inputs:
      trigger:
        description: 'Origin event for scheduled runs'
        required: false
        default: 'workflow_call'
        type: string
      pr_labels:
        description: 'Comma-separated PR labels'
        required: false
        default: ''
        type: string
      pr_base_ref:
        description: 'Base ref name for pull_request'
        required: false
        default: ''
        type: string
      pr_base_sha:
        description: 'Base sha for pull_request'
        required: false
        default: ''
        type: string
      pr_is_fork:
        description: 'Whether the PR head is from a fork'
        required: false
        default: 'false'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  extended:
    permissions:
      contents: read
      issues: write
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    runs-on: ubuntu-latest
    if: ${{ (github.event_name != 'pull_request' && inputs.trigger != 'pull_request') || (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork) || (inputs.trigger == 'pull_request' && inputs.pr_is_fork != 'true') }}
    steps:
      - name: Determine execution flags
        id: flags
        shell: bash
        run: |
          set -euo pipefail
          EVENT_NAME="${{ inputs.trigger || github.event_name }}"
          RUN_EXTENDED=false
          RUN_INTEGRATION=false
          RUN_PROPERTY=false
          RUN_MBT=false
          RUN_MUTATION=false

          if [ "$EVENT_NAME" != "pull_request" ]; then
            RUN_EXTENDED=true
            RUN_INTEGRATION=true
            RUN_PROPERTY=true
            RUN_MBT=true
            RUN_MUTATION=true
          else
            LABELS="${{ inputs.pr_labels }}"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              LABELS="$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" 2>/dev/null || true)"
            fi
            has_label() {
              printf '%s\n' "$LABELS" | tr ',' '\n' | sed -e 's/^ *//' -e 's/ *$//' -e '/^$/d' | grep -Fxq "$1"
            }
            if has_label "run-ci-extended"; then
              RUN_EXTENDED=true
              RUN_INTEGRATION=true
              RUN_PROPERTY=true
              RUN_MBT=true
              RUN_MUTATION=true
            fi
            if has_label "run-integration"; then
              RUN_INTEGRATION=true
            fi
            if has_label "run-property"; then
              RUN_PROPERTY=true
            fi
            if has_label "run-mbt"; then
              RUN_MBT=true
            fi
            if has_label "run-mutation"; then
              RUN_MUTATION=true
            fi
          fi

          SHOULD_RUN=false
          if [ "$RUN_INTEGRATION" = "true" ] || [ "$RUN_PROPERTY" = "true" ] || [ "$RUN_MBT" = "true" ] || [ "$RUN_MUTATION" = "true" ]; then
            SHOULD_RUN=true
          fi

          {
            printf '%s\n' "run_extended=$RUN_EXTENDED"
            printf '%s\n' "run_integration=$RUN_INTEGRATION"
            printf '%s\n' "run_property=$RUN_PROPERTY"
            printf '%s\n' "run_mbt=$RUN_MBT"
            printf '%s\n' "run_mutation=$RUN_MUTATION"
            printf '%s\n' "should_run=$SHOULD_RUN"
          } >> "$GITHUB_OUTPUT"

      - name: Skip (no extended suites requested)
        if: ${{ steps.flags.outputs.should_run != 'true' }}
        run: echo 'CI Extended suites were not requested for this event. Skipping remaining steps.'

      - uses: actions/checkout@v4
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        with:
          fetch-depth: 0

      - name: Setup Node + pnpm
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'

      - name: Install dependencies
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

      - name: Determine heavy test cache key
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        id: heavy-cache-key
        shell: bash
        run: |
          set -euo pipefail
          prefix="ci-heavy-${{ runner.os }}"
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ inputs.trigger }}" = "schedule" ]; then
            key="${prefix}-schedule"
            restore_keys="${prefix}-schedule"$'\n'"${prefix}-"
          else
            key="${prefix}-${GITHUB_SHA}"
            restore_keys="${prefix}-"
          fi
          {
            printf '%s\n' "key=${key}"
            printf '%s\n' "restore_keys<<__RESTORE__"
            printf '%s\n' "${restore_keys}"
            printf '%s\n' "__RESTORE__"
          } >> "$GITHUB_OUTPUT"

      - name: Restore heavy test cache
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        id: restore-heavy
        uses: actions/cache/restore@v4
        with:
          path: .cache/test-results
          key: ${{ steps.heavy-cache-key.outputs.key }}
          restore-keys: ${{ steps.heavy-cache-key.outputs.restore_keys }}

      - name: Rehydrate cached test artifacts
        if: ${{ steps.flags.outputs.should_run == 'true' && steps.restore-heavy.outputs.cache-hit == 'true' }}
        run: node scripts/pipelines/sync-test-results.mjs --restore

      - name: Snapshot heavy test baseline
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        run: node scripts/pipelines/sync-test-results.mjs --snapshot

      - name: Run integration tests
        if: ${{ steps.flags.outputs.run_integration == 'true' }}
        run: pnpm run test:int

      - name: Property-based smoke
        if: ${{ steps.flags.outputs.run_property == 'true' }}
        run: pnpm run test:property

      - name: MBT smoke
        if: ${{ steps.flags.outputs.run_mbt == 'true' }}
        run: pnpm run test:mbt:ci

      - name: Detect pact-related changes (PR only)
        if: ${{ (github.event_name == 'pull_request' || inputs.trigger == 'pull_request') && steps.flags.outputs.run_integration == 'true' }}
        id: pact-paths
        shell: bash
        run: |
          set -euo pipefail
          WATCH_PATH_PATTERN='^(contracts/|src/api/|spec/openapi/|tests/contracts/)'

          BASE_SHA="${{ inputs.pr_base_sha }}"
          if [ -z "$BASE_SHA" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          fi
          if [ -z "$BASE_SHA" ]; then
            BASE_REF="${{ inputs.pr_base_ref }}"
            if [ -z "$BASE_REF" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_REF="${{ github.event.pull_request.base.ref }}"
            fi
            if [ -n "$BASE_REF" ]; then
              git fetch origin "$BASE_REF" --depth=1 || true
              BASE_SHA="$(git rev-parse FETCH_HEAD 2>/dev/null || true)"
            fi
          fi
          if [ -z "$BASE_SHA" ]; then
            printf '%s\n' "pact=false" >> "$GITHUB_OUTPUT"
            printf '%s\n' "Pact diff skipped: base SHA unavailable." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          git fetch origin "$BASE_SHA" --depth=1
          CHANGED="$(git diff --name-only "$BASE_SHA"...HEAD || true)"
          printf '%s\n' "$CHANGED" > /tmp/changed-files.txt
          if printf '%s\n' "$CHANGED" | grep -E "$WATCH_PATH_PATTERN" >/dev/null; then
            printf '%s\n' "pact=true" >> "$GITHUB_OUTPUT"
          else
            printf '%s\n' "pact=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Pact contract smoke
        if: ${{ steps.flags.outputs.run_integration == 'true' && ((github.event_name != 'pull_request' && inputs.trigger != 'pull_request') || steps.pact-paths.outputs.pact == 'true') }}
        run: pnpm run pipelines:pact

      - name: Pact contract smoke (skipped)
        if: ${{ (github.event_name == 'pull_request' || inputs.trigger == 'pull_request') && steps.flags.outputs.run_integration == 'true' && steps.pact-paths.outputs.pact == 'false' }}
        run: |
          echo 'Pact contract smoke skipped: no relevant contract changes detected.' >> "$GITHUB_STEP_SUMMARY"

      - name: Prepare mutation auto diff args
        if: ${{ steps.flags.outputs.run_mutation == 'true' }}
        id: mutation-args
        shell: bash
        run: |
          set -euo pipefail
          EVENT_NAME="${{ inputs.trigger || github.event_name }}"
          target_base="origin/main"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            base_ref="${{ inputs.pr_base_ref }}"
            if [ -z "$base_ref" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
              base_ref="${{ github.event.pull_request.base.ref }}"
            fi
            if [ -n "$base_ref" ]; then
              target_base="origin/${base_ref}"
            fi
          fi
          git fetch --no-tags --depth=1 origin "${target_base#origin/}" || true
          {
            printf '%s\n' "base_ref=${target_base}"
            printf '%s\n' 'args<<__MUT_ARGS__'
            printf '%s\n' '--configFile'
            printf '%s\n' 'configs/stryker.config.js'
            printf '%s\n' '__MUT_ARGS__'
          } >> "$GITHUB_OUTPUT"

      - name: Run mutation auto diff (extended)
        if: ${{ steps.flags.outputs.run_mutation == 'true' }}
        id: mutation
        uses: ./.github/actions/mutation-auto-diff
        env:
          STRYKER_TIME_LIMIT: '900'
        with:
          base-ref: ${{ steps.mutation-args.outputs.base_ref }}
          quick: 'true'
          extra-args: ${{ steps.mutation-args.outputs.args }}

      - name: Process mutation results
        if: ${{ steps.flags.outputs.run_mutation == 'true' && hashFiles('reports/mutation/mutation.json') != '' }}
        run: |
          set -euo pipefail
          node scripts/mutation/mutation-report.mjs
          node scripts/mutation/list-survivors.mjs --limit 50 > reports/mutation/survivors.json
          survivors_for_summary="$(node scripts/mutation/list-survivors.mjs --limit 10 || true)"
          {
            printf '%s\n' '## Mutation survivors (top 10)'
            printf '%s\n' '```json'
            printf '%s\n' "${survivors_for_summary:-[]}"
            printf '%s\n' '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload mutation quick report
        if: ${{ steps.flags.outputs.run_mutation == 'true' && hashFiles('reports/mutation/mutation.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: mutation-quick-report
          path: |
            reports/mutation/mutation.json
            reports/mutation/index.html

      - name: Upload mutation survivors artifact
        if: ${{ steps.flags.outputs.run_mutation == 'true' && hashFiles('reports/mutation/survivors.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: mutation-survivors-json
          path: reports/mutation/survivors.json

      - name: Append property harness summary
        if: ${{ steps.flags.outputs.run_property == 'true' }}
        run: |
          if [ -f artifacts/properties/summary.json ]; then
            echo '## Property Harness' >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              "Trace ID: \(.traceId)",
              "Seed: \(.seed)",
              "Runs: \(.runs)",
              "Passed: \(.passed)",
              (if .note then "Note: \(.note)" else empty end)
            ' artifacts/properties/summary.json >> "$GITHUB_STEP_SUMMARY" || echo 'Failed to parse property summary.' >> "$GITHUB_STEP_SUMMARY"
          else
            echo 'Property harness summary not generated.' >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Append MBT summary
        if: ${{ steps.flags.outputs.run_mbt == 'true' }}
        run: |
          if [ -f artifacts/mbt/summary.json ]; then
            echo '## MBT Harness' >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              "Seed: \(.seed)",
              "Runs: \(.runs)",
              "Depth: \(.depth)",
              "Violations: \(.violations)"
            ' artifacts/mbt/summary.json >> "$GITHUB_STEP_SUMMARY" || echo 'Failed to parse MBT summary.' >> "$GITHUB_STEP_SUMMARY"
          else
            echo 'MBT summary not generated.' >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Append CI extended summary
        if: ${{ steps.flags.outputs.should_run == 'true' }}
        env:
          RUN_EXTENDED: ${{ steps.flags.outputs.run_extended }}
          RUN_INTEGRATION: ${{ steps.flags.outputs.run_integration }}
          RUN_PROPERTY: ${{ steps.flags.outputs.run_property }}
          RUN_MBT: ${{ steps.flags.outputs.run_mbt }}
          RUN_MUTATION: ${{ steps.flags.outputs.run_mutation }}
        run: |
          {
            echo '## CI Extended Execution Flags'
            echo "- run_extended: ${RUN_EXTENDED}"
            echo "- run_integration: ${RUN_INTEGRATION}"
            echo "- run_property: ${RUN_PROPERTY}"
            echo "- run_mbt: ${RUN_MBT}"
            echo "- run_mutation: ${RUN_MUTATION}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Compare heavy test trends
        if: ${{ always() && steps.flags.outputs.should_run == 'true' }}
        run: node scripts/pipelines/compare-test-trends.mjs

      - name: Archive heavy test trend history
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && (github.event_name == 'schedule' || inputs.trigger == 'schedule') }}
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f reports/heavy-test-trends.json ]; then
            echo "Trend report not generated; skipping archive."
            exit 0
          fi
          mkdir -p reports/heavy-test-trends-history
          timestamp="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          cp reports/heavy-test-trends.json "reports/heavy-test-trends-history/${timestamp}.json"
          printf 'Archived heavy test trend snapshot: %s\n' "${timestamp}"

      - name: Render heavy test trend summary
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && (github.event_name == 'schedule' || inputs.trigger == 'schedule') }}
        id: heavy-summary
        shell: bash
        run: |
          set -euo pipefail
          node scripts/pipelines/render-heavy-trend-summary.mjs \
            --limit 5 \
            --json-output reports/heavy-test-trends-history/summary.json \
            --warn-mutation-score 98 \
            --critical-mutation-score 96 \
            --warn-mutation-delta -1.0 \
            --critical-mutation-delta -2.5 \
            --warn-property-failed 1 \
            --critical-property-failed 3 \
            --warn-property-failure-rate 0.1 \
            --warn-mbt-violations 1 \
            --critical-mbt-violations 3
          severity=$(jq -r '.highestSeverity' reports/heavy-test-trends-history/summary.json)
          printf '%s\n' "severity=${severity}" >> "$GITHUB_OUTPUT"

      - name: Recommend heavy test thresholds
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && (github.event_name == 'schedule' || inputs.trigger == 'schedule') }}
        shell: bash
        run: |
          set -euo pipefail
          node scripts/pipelines/recommend-heavy-trend-thresholds.mjs \
            --history-dir reports/heavy-test-trends-history \
            --markdown-output reports/heavy-test-trends-history/threshold-recommendation.md \
            --json-output reports/heavy-test-trends-history/threshold-recommendation.json \
            --warn-mutation-score 98 \
            --critical-mutation-score 96 \
            --warn-mutation-delta -1.0 \
            --critical-mutation-delta -2.5 \
            --warn-property-failed 1 \
            --critical-property-failed 3 \
            --warn-property-failure-rate 0.1 \
            --warn-mbt-violations 1 \
            --critical-mbt-violations 3 \
            --min-snapshots 14
          if [ -f reports/heavy-test-trends-history/threshold-recommendation.md ]; then
            printf '\n' >> "$GITHUB_STEP_SUMMARY"
            cat reports/heavy-test-trends-history/threshold-recommendation.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload heavy test trend report
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && github.event_name != 'pull_request' && inputs.trigger != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: heavy-test-trends
          path: reports/heavy-test-trends.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload heavy test trend history
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && (github.event_name == 'schedule' || inputs.trigger == 'schedule') }}
        uses: actions/upload-artifact@v4
        with:
          name: heavy-test-trends-history
          path: reports/heavy-test-trends-history
          if-no-files-found: ignore
          retention-days: 30

      - name: Notify Slack (heavy trend alert)
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && (github.event_name == 'schedule' || inputs.trigger == 'schedule') && steps.heavy-summary.outputs.severity != 'ok' && env.SLACK_WEBHOOK_URL != '' }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ steps.heavy-summary.outputs.severity == 'critical' && '#E01E5A' || '#FFC107' }}
          SLACK_MESSAGE: |
            ${{ steps.heavy-summary.outputs.severity == 'critical' && ':rotating_light:' || ':warning:' }} Heavy test trend ${{ steps.heavy-summary.outputs.severity }} detected in ${{ github.workflow }}
            • run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            • summary: heavy-test-trends-history/summary.md

      - name: Create heavy trend issue
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && (github.event_name == 'schedule' || inputs.trigger == 'schedule') && steps.heavy-summary.outputs.severity == 'critical' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const summaryPath = path.resolve('reports/heavy-test-trends-history/summary.json');
            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
            const snapshots = Array.isArray(summary.snapshots) ? summary.snapshots : [];
            const criticalSnapshot = snapshots.find(s => (s.severity || '').toLowerCase() === 'critical');
            if (!criticalSnapshot) {
              core.info('No critical snapshot detected; skipping issue creation.');
              return;
            }
            const criticalEntries = (criticalSnapshot.entries || []).filter(e => (e.severity || '').toLowerCase() === 'critical');
            const detailLines = criticalEntries.map(entry => {
              const reasons = (entry.reasons || []).join('; ') || 'threshold exceeded';
              return `- **${entry.label}**: ${reasons}`;
            }).join('\n');
            const title = `[CI Extended] Heavy test critical alert - ${criticalSnapshot.label}`;
            const body = [
              '## Alert',
              `- Workflow: ${context.workflow} (run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '- Severity: critical',
              `- Snapshot: ${criticalSnapshot.label}`,
              '- Summary: reports/heavy-test-trends-history/summary.md',
              '- JSON: reports/heavy-test-trends-history/summary.json',
              '',
              '### Details',
              detailLines || '- (no critical entry details recorded)',
              '',
              '## Next Steps',
              '- [ ] Download artifacts and inspect mutation/property/MBT outputs',
              '- [ ] Update issue with root cause and resolution plan',
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['flaky-test', 'ci-stability', 'needs-investigation'],
            });
            core.info(`Issue created for snapshot ${criticalSnapshot.label}`);

      - name: Stage test results for caching
        if: ${{ always() && steps.flags.outputs.should_run == 'true' }}
        run: node scripts/pipelines/sync-test-results.mjs --store

      - name: Save heavy test cache
        if: ${{ always() && steps.flags.outputs.should_run == 'true' && steps.restore-heavy.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: .cache/test-results
          key: ${{ steps.heavy-cache-key.outputs.key }}
