name: Verify Lite

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

concurrency:
  group: verify-lite-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-lite:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Lite sanity (always on PR/main)
        run: |
          printf "Verify Lite: minimal checks enabled. Heavy jobs are label-gated.\n"
      - name: Self-test (non-blocking)
        continue-on-error: true
        run: |
          node scripts/ci/verify-lite-selftest.mjs || true
      - name: Coverage policy (note)
        run: |
          printf "%s\n" "Coverage policy (for reference):" \
          && printf "%s\n" "- Enforce on main: ${COVERAGE_ENFORCE_MAIN:-0}" \
          && printf "%s\n" "- Default threshold: ${COVERAGE_DEFAULT_THRESHOLD:-80} (override via coverage:<pct>)"
        env:
          COVERAGE_ENFORCE_MAIN: ${{ vars.COVERAGE_ENFORCE_MAIN }}
          COVERAGE_DEFAULT_THRESHOLD: ${{ vars.COVERAGE_DEFAULT_THRESHOLD }}
      - name: Coverage policy (summary)
        if: always()
        env:
          COVERAGE_ENFORCE_MAIN: ${{ vars.COVERAGE_ENFORCE_MAIN }}
          COVERAGE_DEFAULT_THRESHOLD: ${{ vars.COVERAGE_DEFAULT_THRESHOLD }}
        run: |
          printf "\n## 📏 Coverage Policy (reference)\n" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- Enforce on main: %s\n" "${COVERAGE_ENFORCE_MAIN:-0}" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- Default threshold: %s (override via coverage:<pct>)\n" "${COVERAGE_DEFAULT_THRESHOLD:-80}" >> "$GITHUB_STEP_SUMMARY" || true
      - uses: actions/checkout@v4
      - name: Enable corepack
        run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Pre-build workspace types (spec-compiler)
        run: pnpm -F @ae-framework/spec-compiler -s run build || true
      - name: Type check (strict verify)
        run: pnpm types:check
      - name: Lint
        run: pnpm lint || true
      - name: Build
        run: pnpm run build
      - name: Tests (fast baseline)
        run: pnpm -s run test:fast
      - name: Baseline summary (note)
        if: always()
        run: |
          printf "\n## ✅ Verify Lite Baseline\n" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- types:check, lint (non-blocking), build, test:fast executed\n" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- heavy steps are label-gated (run-formal / run-resilience)\n" >> "$GITHUB_STEP_SUMMARY" || true
      - name: BDD lint (non-blocking)
        continue-on-error: true
        run: |
          if [ -f scripts/bdd/lint.mjs ]; then node scripts/bdd/lint.mjs; else printf "No BDD linter\n"; fi
      - name: BDD lint (strict; label-gated)
        if: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'enforce-bdd-lint') }}
        env:
          BDD_LINT_STRICT: '1'
          BDD_ROOTS: ${{ vars.BDD_ROOTS }}
        run: |
          node scripts/bdd/lint.mjs
      - name: BDD → LTL suggestions (report-only)
        run: |
          if npm run -s | grep -q "bdd:suggest"; then pnpm -s run bdd:suggest; else printf "No BDD suggest script\n"; fi
      - name: Formal tools check (non-blocking)
        continue-on-error: true
        run: |
          if [ -f scripts/formal/tools-check.mjs ]; then node scripts/formal/tools-check.mjs; fi
      - name: "Run formal (label gated: run-formal)"
        if: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-formal') }}
        run: |
          node scripts/formal/verify-conformance.mjs || true
          node scripts/formal/verify-alloy.mjs || true
          node scripts/formal/verify-tla.mjs --engine=tlc || true
          node scripts/formal/verify-smt.mjs --solver=cvc5 || true
          node scripts/formal/verify-kani.mjs || true
          node scripts/formal/presets-apply.mjs || true
          node scripts/formal/aggregate-formal.mjs || true
          node scripts/formal/print-summary.mjs || true
      - name: Aggregate adapters/formal/properties (non-blocking)
        continue-on-error: true
        run: |
          if npm run -s | grep -q "artifacts:aggregate"; then pnpm -s run artifacts:aggregate; fi
          node scripts/simulation/deterministic-runner.mjs || true
      - name: Resilience quick (label-gated, non-blocking)
        if: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-resilience') }}
        continue-on-error: true
        run: |
          pnpm -s vitest run "tests/resilience/**/*.fast.*.test.ts" --reporter=verbose --run --coverage=false || true
      - name: BDD step lint (non-blocking)
        continue-on-error: true
        run: |
          if [ -f scripts/bdd/step-lint.mjs ]; then node scripts/bdd/step-lint.mjs || true; fi
      - name: BDD step lint (strict; label-gated)
        if: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'enforce-bdd-lint') }}
        run: |
          if [ -f scripts/bdd/step-lint.mjs ]; then node scripts/bdd/step-lint.mjs; fi
      - name: Render PR summary (digest)
        env:
          SUMMARY_MODE: digest
          SUMMARY_LANG: ${{ (github.event.pull_request && contains(github.event.pull_request.labels.*.name, 'lang:ja')) && 'ja' || 'en' }}
        run: |
          if [ -f scripts/summary/render-pr-summary.mjs ]; then node scripts/summary/render-pr-summary.mjs; fi
          [ -f artifacts/summary/PR_SUMMARY.md ] && cat artifacts/summary/PR_SUMMARY.md >> "$GITHUB_STEP_SUMMARY" || true
      - name: PR label gates (summary)
        if: always()
        env:
          IS_PR: ${{ github.event_name == 'pull_request' }}
          RUN_FORMAL: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-formal') && '1' || '0' }}
          RUN_RESILIENCE: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-resilience') && '1' || '0' }}
        run: |
          printf "\nVerify Lite — label gates (PR only)\n" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- run-formal: %s\n" "${RUN_FORMAL:-0}" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- run-resilience: %s\n" "${RUN_RESILIENCE:-0}" >> "$GITHUB_STEP_SUMMARY" || true
