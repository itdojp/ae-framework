name: Parallel Test Coordinator

on:
  workflow_dispatch:
    inputs:
      suites:
        description: "実行するスイート名（カンマ区切り。例: unit,integration,quality）。空の場合は全スイート"
        required: false
        default: "unit,integration,quality"
      exclude_suites:
        description: "除外するスイート名（カンマ区切り。例: e2e,flake-detection）"
        required: false
        default: ""
      max_concurrency:
        description: "最大同時実行数（MAX_TEST_CONCURRENCY）"
        required: false
        default: "4"
      use_container_unit:
        description: "unit をコンテナ実行する（AE_PARALLEL_USE_CONTAINER=1）"
        required: false
        default: "0"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.suites || 'all' }}-${{ github.event.inputs.exclude_suites || 'none' }}
  cancel-in-progress: true

env:
  NODE_ENV: test
  CI: true

jobs:
  parallel-test-coordinator:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'

      - name: Install deps
        run: |
          pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

      - name: Create reports/logs directory
        run: |
          mkdir -p reports logs

      - name: Run parallel test coordinator
        env:
          MAX_TEST_CONCURRENCY: ${{ github.event.inputs.max_concurrency }}
          AE_PARALLEL_SUITES: ${{ github.event.inputs.suites }}
          AE_PARALLEL_EXCLUDE_SUITES: ${{ github.event.inputs.exclude_suites }}
          AE_PARALLEL_USE_CONTAINER: ${{ github.event.inputs.use_container_unit }}
        run: |
          pnpm run test:ci:parallel

      - name: Upload coordinator artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parallel-test-coordinator-artifacts
          path: |
            reports/parallel-execution/**
            logs/**
          if-no-files-found: warn

