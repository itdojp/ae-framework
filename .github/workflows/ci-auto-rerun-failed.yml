name: Auto Rerun Failed Jobs (PR)

on:
  workflow_run:
    workflows:
      - Full CI (Comprehensive Testing)
      - Verify Lite
      - Verify Traceability
      - PR Verify
      - testing-ddd-scripts
      - coverage-check
    types: [completed]

permissions:
  actions: write
  contents: read
  issues: write
  pull-requests: write

jobs:
  rerun-failed:
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.run_attempt == 1
    runs-on: ubuntu-latest
    steps:
      - name: Rerun failed jobs once
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.payload.workflow_run.id;
            const workflowName = context.payload.workflow_run.name;
            await github.rest.actions.reRunWorkflowFailedJobs({ owner, repo, run_id: runId });

            const pr = (context.payload.workflow_run.pull_requests || [])[0];
            if (!pr || !pr.number) {
              core.notice('No PR context available for rerun comment.');
              return;
            }

            const body = [
              '### CI Auto Rerun',
              `Workflow \`${workflowName}\` failed on attempt 1.`,
              `Triggered a one-time rerun of failed jobs for run ${runId}.`,
              'If it fails again, please investigate the root cause.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body
            });
