name: Daily Flake Maintenance
on:
  schedule:
    - cron: '0 10 * * *' # Daily at 19:00 JST
  workflow_dispatch:
concurrency:
  group: flake-maintenance-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: corepack enable
      - run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      
      - name: Install bc for calculations
        run: sudo apt-get update && sudo apt-get install -y bc
      
      - name: Run flake maintenance
        run: |
          printf "%s\n" "ðŸ”§ Running daily flake isolation maintenance..."
          pnpm run flake:maintenance
      
      - name: Generate maintenance report
        run: |
          printf "%s\n" "ðŸ“Š Generating maintenance report..."
          pnpm run flake:report
          
          # Display current status
          printf "%s\n" "ðŸ“‹ Current flake isolation status:"
          pnpm run flake:list
      
      - name: Upload maintenance reports
        uses: actions/upload-artifact@v4
        with:
          name: flake-maintenance-report-${{ github.run_id }}
          path: |
            reports/flake-reports/
            config/flaky-tests.json
            config/test-patterns.json
          retention-days: 30
      
      - name: Check for recovery candidates
        id: recovery-check
        run: |
          # Check if any tests have been recovered
          if [ -f "reports/flake-reports/latest-flake-isolation-report.json" ]; then
            recovered_count=$(jq -r '.isolatedTests | map(select(.status == "recovered")) | length' reports/flake-reports/latest-flake-isolation-report.json)
            printf "%s\n" "recovered_count=$recovered_count" >> "$GITHUB_OUTPUT"
            printf "%s\n" "Found $recovered_count recovered tests"
          else
            printf "%s\n" "recovered_count=0" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Create recovery notification
        if: steps.recovery-check.outputs.recovered_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const recoveredCount = '${{ steps.recovery-check.outputs.recovered_count }}';
            
            const title = `ðŸŽ‰ Flaky Test Recovery - ${recoveredCount} Tests Recovered`;
            
            const body = `## ðŸŽ‰ Flaky Test Recovery Notification
            
            **Recovery Date:** ${new Date().toISOString()}  
            **Tests Recovered:** ${recoveredCount}
            
            ### ðŸ“Š Recovery Summary
            The daily flake maintenance process has identified ${recoveredCount} previously flaky test(s) that have shown stable behavior and are candidates for re-integration into the main test suite.
            
            ### ðŸŽ¯ Next Steps
            1. **Review** the recovered tests in the flake isolation report
            2. **Consider** re-enabling these tests in the main CI pipeline
            3. **Monitor** their behavior closely after re-integration
            4. **Update** test patterns configuration if needed
            
            ### ðŸ“‹ Actions Required
            - [ ] Review flake isolation report
            - [ ] Test recovered patterns in isolation
            - [ ] Update CI test configuration
            - [ ] Monitor for continued stability
            
            **Auto-generated by Daily Flake Maintenance Workflow**  
            *Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['flaky-test', 'recovered', 'maintenance', 'automated']
            });
            
            console.log(`Created recovery notification issue`);
      
      - name: Update test patterns
        run: |
          printf "%s\n" "ðŸ”„ Checking if test patterns need updating..."
          
          if [ -f "config/test-patterns.json" ]; then
            printf "%s\n" "âœ… Test patterns configuration updated"
            git diff --name-only config/test-patterns.json || true
          else
            printf "%s\n" "âš ï¸ No test patterns configuration found"
          fi
      
      - name: Summary report
        run: |
          printf "%s\n" "ðŸ“‹ Daily Flake Maintenance Complete"
          printf "%s\n" "=================================="
          
          if [ -f "reports/flake-reports/latest-flake-isolation-report.json" ]; then
            printf "%s\n" "ðŸ“Š Current Status:"
            jq -r '.summary | to_entries | map("  \(.key): \(.value)") | .[]' reports/flake-reports/latest-flake-isolation-report.json
            
            printf "%s\n" ""
            printf "%s\n" "ðŸ’¡ Recommendations:"
            jq -r '.recommendations[] | "  [\(.priority | ascii_upcase)] \(.message)"' reports/flake-reports/latest-flake-isolation-report.json
          else
            printf "%s\n" "âš ï¸ No flake isolation report found"
          fi
          
          printf "%s\n" "=================================="
      - name: Flake Maintenance (summary)
        if: always()
        run: |
          printf "\n## ðŸ§¼ Flake Maintenance\n" >> "$GITHUB_STEP_SUMMARY" || true
          printf "- Concurrency: flake-maintenance-${{ github.ref }} (cancel in progress)\n" >> "$GITHUB_STEP_SUMMARY" || true
