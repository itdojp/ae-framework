name: Quality Gates
on:
  pull_request:
    # Run quality gates only when code paths change
    paths:
      - 'src/**'
      - 'packages/**'
      - 'apps/**'
      - 'tests/**'
      - 'configs/**'
      - 'scripts/**'
      - 'types/**'
  push:
    tags: ['v*']
    paths-ignore:
      - 'docs/**'
      - '*.md'
  workflow_call:
    # Allow reuse from other workflows (e.g., release)
    inputs:
      environment:
        required: false
        type: string
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions: read-all
jobs:
  integration:
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: test:int
  types:
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: types:check
  a11y:
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: test:a11y
  coverage:
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: test:coverage
  type-coverage:
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: typecov
  type-coverage-report:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare pnpm
        uses: ./.github/actions/setup-pnpm
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Enable corepack
        run: corepack enable
      - name: Install deps
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Run type-coverage
        id: typecov
        run: |
          set -e
          OUT=$(pnpm -s run typecov || true)
          printf "%s\n" "$OUT"
          # Extract last percentage like: "type coverage: 67.89%"
          PCT=$(printf "%s\n" "$OUT" | rg -o "type coverage:\s*[0-9.]+%" -n | tail -n1 | awk '{print $3}')
          printf "%s\n" "pct=$PCT" >> "$GITHUB_OUTPUT"
      - name: Comment type coverage on PR
        if: steps.typecov.outputs.pct != ''
        uses: actions/github-script@v7
        with:
          script: |
            const pct = '${{ steps.typecov.outputs.pct }}';
            const labels = (context.payload.pull_request?.labels || []).map(l => l.name);
            const enforcing = labels.includes('enforce-typecov');
            const threshold = enforcing ? '70%' : '65%';
            const status = enforcing ? 'enforced (label: enforce-typecov)' : 'report-only';
            const body = [
              '### Type Coverage',
              '',
              `Current type coverage: **${pct}**`,
              `Policy: **${status}**, Threshold: **${threshold}**`,
              '',
              'Docs: `docs/quality/type-coverage-policy.md`'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
  type-coverage-threshold:
    if: github.event_name == 'pull_request' && contains(join(fromJSON(toJSON(github.event.pull_request.labels)).*.name, ','), 'enforce-typecov')
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: typecov:check:70
  types-tests:
    uses: ./.github/workflows/common/ci-core.yml
    with:
      node-version: '20'
      run-script: test:types
