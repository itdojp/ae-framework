name: Quality Gates
on:
  pull_request:
    # Run quality gates only when code paths change
    paths:
      - 'src/**'
      - 'packages/**'
      - 'apps/**'
      - 'tests/**'
      - 'configs/**'
      - 'scripts/**'
      - 'types/**'
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'packages/**'
      - 'apps/**'
      - 'tests/**'
      - '.github/workflows/quality-gates-centralized.yml'
      - '!docs/**'
      - '!**/*.md'
  workflow_call:
    # Allow reuse from other workflows (e.g., release)
    inputs:
      environment:
        required: false
        type: string
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions: read-all
jobs:
  integration:
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: test:int
  types:
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: types:check
  a11y:
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: test:a11y
  coverage:
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: test:coverage
  dod:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Run DoD composite gate
        run: pnpm run quality:run -- --env=testing --gates=dod --sequential
      - name: Upload quality report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: quality-gates-report
          path: reports/quality-gates
          if-no-files-found: warn
  type-coverage:
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: typecov
  type-coverage-report:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Install deps
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Run type-coverage
        id: typecov
        run: |
          set -e
          OUT=$(pnpm -s run typecov || true)
          printf "%s\n" "$OUT"
          # Extract last percentage like: "type coverage: 67.89%"
          PCT=$(printf "%s\n" "$OUT" | rg -o "type coverage:\s*[0-9.]+%" -n | tail -n1 | awk '{print $3}')
          printf "%s\n" "pct=$PCT" >> "$GITHUB_OUTPUT"
      - name: Comment type coverage on PR
        if: steps.typecov.outputs.pct != ''
        uses: actions/github-script@v7
        with:
          script: |
            const pct = '${{ steps.typecov.outputs.pct }}';
            const labels = (context.payload.pull_request?.labels || []).map(l => l.name);
            const enforcing = labels.includes('enforce-typecov');
            const threshold = enforcing ? '70%' : '65%';
            const status = enforcing ? 'enforced (label: enforce-typecov)' : 'report-only';
            const body = [
              '### Type Coverage',
              '',
              `Current type coverage: **${pct}**`,
              `Policy: **${status}**, Threshold: **${threshold}**`,
              '',
              'Docs: `docs/quality/type-coverage-policy.md`'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
  type-coverage-threshold:
    if: github.event_name == 'pull_request' && contains(join(fromJSON(toJSON(github.event.pull_request.labels)).*.name, ','), 'enforce-typecov')
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: typecov:check:70
  pr-quality-comment:
    if: ${{ always() && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    needs: [dod]
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Download quality report
        uses: actions/download-artifact@v4
        with:
          name: quality-gates-report
          path: reports/quality-gates
      - name: Locate quality report
        id: report
        run: |
          REPORT=$(find reports/quality-gates -name 'quality-report-*-latest.json' | head -n1 || true)
          printf "report=%s\n" "$REPORT" >> "$GITHUB_OUTPUT"
      - name: Load previous quality summary
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e
          mkdir -p artifacts/quality
          marker='<!-- AE-PR-QUALITY -->'
          comment=$(gh api "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" --jq '.[] | select(.body | contains("'"$marker"'")) | .body' | head -n1 || true)
          if [ -n "$comment" ]; then
            export BODY="$comment"
            node - <<'NODE' || true
            const fs = require('fs');
            const body = process.env.BODY || '';
            const match = body.match(/<!-- AE-PR-QUALITY-JSON ([\s\S]*?) -->/);
            if (match && match[1]) {
              fs.mkdirSync('artifacts/quality', { recursive: true });
              fs.writeFileSync('artifacts/quality/summary.prev.json', match[1]);
              console.log('Loaded previous quality summary');
            }
          NODE
          fi
      - name: Render quality summary
        env:
          QUALITY_REPORT_PATH: ${{ steps.report.outputs.report }}
          QUALITY_PREVIOUS_SUMMARY: artifacts/quality/summary.prev.json
        run: node scripts/quality/render-quality-pr-comment.mjs
      - name: Post or update quality comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e
          marker='<!-- AE-PR-QUALITY -->'
          {
            printf '%s\n\n' "$marker"
            cat artifacts/quality/PR_QUALITY.md
            printf '\n\n<!-- AE-PR-QUALITY-JSON '
            cat artifacts/quality/summary.json
            printf ' -->\n'
          } > artifacts/quality/comment-body.txt
          existing_id=$(gh api "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" --jq '.[] | select(.body | contains("'"$marker"'")) | .id' | head -n1 || true)
          if [ -n "$existing_id" ]; then
            gh api -X PATCH "repos/$GITHUB_REPOSITORY/issues/comments/$existing_id" -f body=@artifacts/quality/comment-body.txt
          else
            gh api -X POST "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" -f body=@artifacts/quality/comment-body.txt
          fi
  types-tests:
    uses: ./.github/workflows/ci-core.yml
    with:
      node-version: '20'
      run-script: test:types
