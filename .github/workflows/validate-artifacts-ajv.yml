name: validate-artifacts-ajv
on:
  pull_request:
permissions:
  contents: read
jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      strict: ${{ steps.gate.outputs.strict }}
    steps:
      - uses: actions/github-script@v7
        id: gate
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l=>l.name);
            const strict = labels.includes("enforce-artifacts");
            core.setOutput("strict", String(strict));
  validate:
    needs: gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Enable corepack
        run: corepack enable
      - name: Install deps (pnpm)
        run: pnpm install --no-frozen-lockfile
      - name: Ensure ajv, ajv-cli, jq
        run: pnpm dlx npm@10 add -D ajv ajv-cli jq || pnpm add -D ajv ajv-cli jq || true
      - name: Validate adapter summaries
        run: npx ajv -s docs/schemas/artifacts-adapter-summary.schema.json -d "artifacts/*/summary.json" --strict=false || true
        continue-on-error: ${{ github.ref != 'refs/heads/main' && needs.gate.outputs.strict != 'true' }}
      - name: Validate formal summary
        run: |
          if [ -f formal/summary.json ]; then npx ajv -s docs/schemas/formal-summary.schema.json -d formal/summary.json --strict=false; fi
        continue-on-error: ${{ github.ref != 'refs/heads/main' && needs.gate.outputs.strict != 'true' }}
      - name: Validate property summaries
        run: |
          if [ -f artifacts/properties/summary.json ]; then \
            if jq -e 'type=="array"' artifacts/properties/summary.json >/dev/null; then \
              jq -c '.[]' artifacts/properties/summary.json | while read -r item; do \
                printf "%s\n" "$item" | npx ajv -s docs/schemas/artifacts-properties-summary.schema.json -d /dev/stdin --strict=false; \
              done; \
            else \
              npx ajv -s docs/schemas/artifacts-properties-summary.schema.json -d artifacts/properties/summary.json --strict=false; \
            fi; \
          fi
        continue-on-error: ${{ github.ref != 'refs/heads/main' && needs.gate.outputs.strict != 'true' }}
