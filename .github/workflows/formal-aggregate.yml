name: Formal Reports Aggregate

on:
  workflow_call:
    inputs:
      source_run_id:
        description: "Workflow run id to download artifacts from"
        required: false
        type: string
      pr_number:
        description: "Pull request number to comment on"
        required: false
        type: string
      strict_formal_summary_v1:
        description: "Fail the workflow if Formal Summary v1 is missing/invalid"
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      source_run_id:
        description: "Workflow run id to download artifacts from"
        required: false
        type: string
      pr_number:
        description: "Pull request number to comment on"
        required: false
        type: string
      strict_formal_summary_v1:
        description: "Fail the workflow if Formal Summary v1 is missing/invalid"
        required: false
        type: boolean
        default: false
concurrency:
  group: ${{ github.workflow }}-${{ inputs.pr_number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  aggregate:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.strict_formal_summary_v1 != true }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts_dl
          run-id: ${{ inputs.source_run_id != '' && inputs.source_run_id || github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN || github.token }}
      - name: Aggregate formal reports
        id: agg
        run: |
          node scripts/formal/aggregate-formal-reports.cjs
      - name: Generate Formal Summary v1 (non-blocking)
        if: always()
        continue-on-error: ${{ inputs.strict_formal_summary_v1 != true }}
        run: |
          node scripts/formal/generate-formal-summary-v1.mjs --in artifacts_dl --out artifacts/formal/formal-summary-v1.json
      - name: Upload aggregate
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-reports-aggregate
          path: artifacts/formal/formal-aggregate.md
      - name: Upload aggregate JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-reports-aggregate-json
          path: artifacts/formal/formal-aggregate.json
      - name: Upload Formal Summary v1 JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-summary-v1
          path: artifacts/formal/formal-summary-v1.json
      - name: Validate Formal Summary v1 JSON (non-blocking)
        if: always()
        run: |
          node scripts/ci/validate-formal-summary-v1.mjs artifacts/formal/formal-summary-v1.json schema/formal-summary-v1.schema.json || true
      - name: Enforce Formal Summary v1 JSON (strict)
        if: inputs.strict_formal_summary_v1 == true
        run: |
          node scripts/ci/validate-formal-summary-v1.mjs --require artifacts/formal/formal-summary-v1.json schema/formal-summary-v1.schema.json
      - name: Validate aggregate JSON (non-blocking)
        if: always()
        run: |
          node scripts/formal/validate-aggregate-json.mjs || true
      - name: Validate conformance summary (non-blocking)
        if: always()
        run: |
          node scripts/formal/validate-conformance-summary.mjs || true
      - name: Comment on PR (upsert)
        if: (github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch') && inputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const header = '<!-- AE-FORMAL-AGGREGATE -->\n';
            const body = header + fs.readFileSync('artifacts/formal/formal-aggregate.md','utf-8');
            const { owner, repo } = context.repo;
            const issue_number = Number(process.env.PR_NUMBER || 0);
            if (!issue_number) {
              core.info('PR number not provided; skipping comment.');
              return;
            }
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const mine = comments.data.find(c => c.body && c.body.startsWith('<!-- AE-FORMAL-AGGREGATE -->'));
            if (mine && mine.body === body) {
              core.info('Aggregate unchanged; skipping update');
            } else if (mine) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: mine.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
