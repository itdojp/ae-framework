name: ae-ci
on:
  workflow_call:
    inputs:
      trigger:
        description: 'Origin event name (pull_request/push/workflow_call)'
        required: false
        default: 'workflow_call'
        type: string
      pr_labels:
        description: 'Comma-separated PR labels'
        required: false
        default: ''
        type: string
      run_qa:
        description: 'Force QA execution (true/false)'
        required: false
        default: false
        type: boolean
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa_gate:
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.set.outputs.run }}
      non_blocking: ${{ steps.set.outputs.non_blocking }}
    steps:
      - uses: actions/github-script@v7
        id: set
        with:
          script: |
            const eventName = context.eventName;
            const trigger = process.env.TRIGGER || eventName;
            const rawLabels = eventName === 'pull_request'
              ? (context.payload.pull_request?.labels || []).map(l=>l.name).join(',')
              : (process.env.PR_LABELS || '');
            const labels = rawLabels.split(',').map(v => v.trim()).filter(Boolean);
            const runByLabel = labels.includes('run-qa');
            const nonBlocking = labels.includes('ci-non-blocking');
            const runByDispatch = eventName === 'workflow_dispatch';
            const runByInput = process.env.RUN_QA === 'true';
            const enablePush = process.env.AE_QA_BENCH_PUSH === 'true' && (eventName === 'push' || trigger === 'push');
            const shouldRun = runByLabel || runByDispatch || runByInput || enablePush;
            core.setOutput('run', String(shouldRun));
            core.setOutput('non_blocking', String(nonBlocking));
        env:
          AE_QA_BENCH_PUSH: ${{ vars.AE_QA_BENCH_PUSH }}
          TRIGGER: ${{ inputs.trigger }}
          PR_LABELS: ${{ inputs.pr_labels }}
          RUN_QA: ${{ inputs.run_qa }}
  qa-bench:
    needs: qa_gate
    if: ${{ needs.qa_gate.outputs.run == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: ${{ needs.qa_gate.outputs.non_blocking == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Install
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Build
        run: pnpm run build
      - name: Bin smoke check
        run: node scripts/ci/check-bins.mjs
      - name: QA (light)
        run: node dist/src/cli/index.js qa --light
      - name: Bench (seeded, dry-run light)
        run: |
          AE_SEED=123 node dist/src/cli/benchmark-cli.js run --ci --light --dry-run || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ae-artifacts
          path: artifacts/
