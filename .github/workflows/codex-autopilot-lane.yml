name: Codex Autopilot Lane

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number"
        required: true
      dry_run:
        description: "Dry-run mode"
        required: false
        default: "false"
      max_rounds:
        description: "Override max rounds"
        required: false

concurrency:
  group: >-
    codex-autopilot-lane-${{
      github.event_name == 'pull_request' && github.event.pull_request.number
      || github.event_name == 'issue_comment' && github.event.issue.number
      || inputs.pr_number
    }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: write
  issues: write
  pull-requests: write

jobs:
  autopilot:
    if: >-
      vars.AE_AUTOMATION_GLOBAL_DISABLE != '1'
      && (
        github.event_name == 'workflow_dispatch'
        || (
          vars.AE_CODEX_AUTOPILOT_ENABLED == '1'
          && (
            (
              github.event_name == 'pull_request'
              && github.event.pull_request.head.repo.fork == false
              && contains(github.event.pull_request.labels.*.name, 'autopilot:on')
            )
            || (
              github.event_name == 'issue_comment'
              && github.event.issue.pull_request
              && contains(github.event.comment.body, '/autopilot run')
              && (
                github.event.comment.author_association == 'MEMBER'
                || github.event.comment.author_association == 'OWNER'
                || github.event.comment.author_association == 'COLLABORATOR'
              )
            )
          )
        )
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.repository.default_branch }}
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "20"
      - name: Resolve automation config
        env:
          AE_AUTOMATION_PROFILE: ${{ vars.AE_AUTOMATION_PROFILE || '' }}
          AE_COPILOT_AUTO_FIX: ${{ vars.AE_COPILOT_AUTO_FIX || '' }}
          AE_COPILOT_AUTO_FIX_SCOPE: ${{ vars.AE_COPILOT_AUTO_FIX_SCOPE || '' }}
          AE_COPILOT_AUTO_FIX_LABEL: ${{ vars.AE_COPILOT_AUTO_FIX_LABEL || '' }}
          AE_AUTO_MERGE: ${{ vars.AE_AUTO_MERGE || '' }}
          AE_AUTO_MERGE_MODE: ${{ vars.AE_AUTO_MERGE_MODE || '' }}
          AE_AUTO_MERGE_LABEL: ${{ vars.AE_AUTO_MERGE_LABEL || '' }}
          AE_GH_THROTTLE_MS: ${{ vars.AE_GH_THROTTLE_MS || '' }}
          AE_GH_RETRY_MAX_ATTEMPTS: ${{ vars.AE_GH_RETRY_MAX_ATTEMPTS || '' }}
          AE_GH_RETRY_INITIAL_DELAY_MS: ${{ vars.AE_GH_RETRY_INITIAL_DELAY_MS || '' }}
          AE_GH_RETRY_MAX_DELAY_MS: ${{ vars.AE_GH_RETRY_MAX_DELAY_MS || '' }}
          AE_GH_RETRY_DEBUG: ${{ vars.AE_GH_RETRY_DEBUG || '' }}
          COPILOT_REVIEW_WAIT_MINUTES: ${{ vars.COPILOT_REVIEW_WAIT_MINUTES || '' }}
          COPILOT_REVIEW_MAX_ATTEMPTS: ${{ vars.COPILOT_REVIEW_MAX_ATTEMPTS || '' }}
        run: |
          node scripts/ci/lib/automation-config.mjs --format github-env >> "$GITHUB_ENV"
          node scripts/ci/lib/automation-config.mjs --format summary >> "$GITHUB_STEP_SUMMARY"
      - name: Run codex autopilot lane
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event_name == 'pull_request' && github.event.pull_request.number || github.event_name == 'issue_comment' && github.event.issue.number || '' }}
          AE_AUTOPILOT_DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || vars.AE_AUTOPILOT_DRY_RUN || 'false' }}
          AE_AUTOPILOT_MAX_ROUNDS: ${{ github.event_name == 'workflow_dispatch' && inputs.max_rounds || vars.AE_AUTOPILOT_MAX_ROUNDS || '3' }}
          AE_AUTOPILOT_ROUND_WAIT_SECONDS: ${{ vars.AE_AUTOPILOT_ROUND_WAIT_SECONDS || '8' }}
        run: node scripts/ci/codex-autopilot-lane.mjs
