name: Formal Verify

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  workflow_dispatch:
    inputs:
      target:
        description: "Target to run (all|conformance|alloy|tla|smt|apalache|kani|spin|csp|lean)"
        required: false
        default: "all"
      tlaFile:
        description: "TLA file to run (for Apalache/TLA)"
        required: false
        default: "spec/tla/DomainSpec.tla"
      engine:
        description: "TLA+ engine (tlc|apalache)"
        required: false
        default: "tlc"
      solver:
        description: "SMT solver (z3|cvc5)"
        required: false
        default: "z3"
      alloyJar:
        description: "Path to Alloy jar (optional)"
        required: false
        default: ""
      tlaToolsJar:
        description: "Path to TLA+ tla2tools.jar (optional)"
        required: false
        default: ""
concurrency:
  group: >-
    ${{ github.event_name == 'workflow_dispatch'
      && format('{0}-{1}-{2}-{3}-{4}', github.workflow, github.ref, inputs.target || 'all', inputs.engine || 'tlc', inputs.tlaFile || 'manual')
      || format('{0}-{1}-{2}', github.workflow, github.event.pull_request.number || github.ref, inputs.target || 'all') }}
  cancel-in-progress: true

env:
  APALACHE_VERSION: '0.50.3'
  KANI_VERSION: '0.67.0'
  CSPX_REPO: 'https://github.com/itdojp/cspx'
  # Pinned for reproducibility and supply-chain hardening (immutable commit).
  # Includes expanded cspx docs/report updates and ae-framework summary contract.
  CSPX_REF: '8a67639ea4d3f715e27feb8cd728f46866a905db'

jobs:
  verify-conformance:
    name: verify:conformance (stub)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'conformance'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
      - name: Print run context
        run: node scripts/formal/print-context.mjs || true
      - name: Show formal tools availability (non-blocking)
        run: node scripts/formal/tools-check.mjs || true
      - name: Run verify:conformance stub
        run: node scripts/formal/verify-conformance.mjs
      - name: Validate trace schema (sample)
        run: node scripts/formal/trace-validate.mjs
      - name: Aggregate formal summaries (local)
        run: node scripts/formal/aggregate-formal.mjs
      - name: Conformance driver (stub)
        run: node scripts/formal/conformance-driver.mjs || true
      - name: Print formal summary (console)
        run: node scripts/formal/print-summary.mjs
      - name: Upload formal reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports
          path: |
            artifacts/hermetic-reports/
      - name: Upload conformance summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-conformance
          path: |
            artifacts/hermetic-reports/formal/conformance-summary.json

  verify-alloy:
    name: verify:alloy (stub)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'alloy'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java (Alloy)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Cache Alloy jar
        uses: actions/cache@v4
        with:
          path: .cache/tools/alloy.jar
          key: ${{ runner.os }}-alloy-6.2.0
      - name: Download Alloy jar
        run: |
          set -euo pipefail
          JAR_PATH="$PWD/.cache/tools/alloy.jar"
          if [ ! -f "$JAR_PATH" ]; then
            mkdir -p "$(dirname "$JAR_PATH")"
            curl -L -sS -o "$JAR_PATH" "https://github.com/AlloyTools/org.alloytools.alloy/releases/download/v6.2.0/org.alloytools.alloy.dist.jar"
          fi
      - name: Check Alloy tooling presence (non-blocking)
        run: |
          printf "%s\n" "Checking Alloy tooling..."
          node -e "console.log('Alloy tooling check stub ok')"
      - name: Run verify:alloy (sample)
        env:
          ALLOY_JAR: ${{ github.event_name == 'workflow_dispatch' && inputs.alloyJar || format('{0}/.cache/tools/alloy.jar', github.workspace) }}
          ALLOY_RUN_CMD: java -jar $ALLOY_JAR exec -q -o - -f {file}
          JAVA_TOOL_OPTIONS: -Djava.awt.headless=true
        run: node scripts/formal/verify-alloy.mjs --file spec/alloy/Domain.als || true
      - name: Upload Alloy summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-alloy
          path: |
            artifacts/hermetic-reports/formal/alloy-summary.json

  verify-tla:
    name: verify:tla (stub)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'tla'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Run verify:tla stub
        env:
          TLA_ENGINE: ${{ github.event_name == 'workflow_dispatch' && inputs.engine || 'tlc' }}
          TLA_TOOLS_JAR: ${{ github.event_name == 'workflow_dispatch' && inputs.tlaToolsJar || '' }}
          TLA_FILE: ${{ github.event_name == 'workflow_dispatch' && inputs.tlaFile || 'spec/tla/DomainSpec.tla' }}
        run: node scripts/formal/verify-tla.mjs --engine="$TLA_ENGINE" --file "$TLA_FILE" || true
      - name: Upload TLA summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-tla
          path: |
            artifacts/hermetic-reports/formal/tla-summary.json

  verify-smt:
    name: verify:smt (stub)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'smt'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Install SMT solvers (z3/cvc5)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y z3
          if apt-cache show cvc5 >/dev/null 2>&1; then
            sudo apt-get install -y cvc5
          else
            echo "cvc5 not available via apt; skipping"
          fi
          z3 --version || true
          cvc5 --version || true
      - name: Check SMT tooling presence (non-blocking)
        run: |
          printf "%s\n" "Checking SMT tooling..."
          node -e "console.log('SMT tooling check stub ok')"
      - name: Run verify:smt (sample)
        env:
          SMT_SOLVER: ${{ github.event_name == 'workflow_dispatch' && inputs.solver || 'z3' }}
        run: node scripts/formal/verify-smt.mjs --solver="$SMT_SOLVER" --file spec/smt/sample.smt2 || true
      - name: Upload SMT summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-smt
          path: |
            artifacts/hermetic-reports/formal/smt-summary.json

  verify-apalache:
    name: verify:apalache (stub)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'apalache'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java (Apalache)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Cache Apalache
        uses: actions/cache@v4
        with:
          path: .cache/tools/apalache
          key: ${{ runner.os }}-apalache-${{ env.APALACHE_VERSION }}
      - name: Install Apalache (cached)
        run: |
          set -euo pipefail
          TOOL_DIR="$PWD/.cache/tools/apalache"
          mkdir -p "$TOOL_DIR"
          if [ ! -x "$TOOL_DIR/bin/apalache-mc" ]; then
            curl -L -sS -o /tmp/apalache.tgz "https://github.com/apalache-mc/apalache/releases/download/v${APALACHE_VERSION}/apalache-${APALACHE_VERSION}.tgz"
            tar -xzf /tmp/apalache.tgz -C "$TOOL_DIR" --strip-components=1
          fi
          export PATH="$TOOL_DIR/bin:$PATH"
          echo "$TOOL_DIR/bin" >> "$GITHUB_PATH"
          apalache-mc version || true
      - name: Check Apalache presence (non-blocking)
        run: |
          node scripts/formal/check-apalache.mjs || true
      - name: Run verify:apalache (summary, non-blocking)
        run: |
          node scripts/formal/verify-apalache.mjs --file "${{ inputs.tlaFile || 'spec/tla/DomainSpec.tla' }}" || true
      - name: Upload Apalache summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-apalache
          path: |
            artifacts/hermetic-reports/formal/apalache-summary.json
            artifacts/hermetic-reports/formal/apalache-output.txt
      - name: Validate Apalache summary shape (non-blocking)
        if: always()
        run: |
          node scripts/formal/validate-apalache-summary.mjs || true
      - name: "Enforce Apalache (label: enforce-formal)"
        if: contains(github.event.pull_request.labels.*.name, 'enforce-formal')
        run: |
          FILE="artifacts/hermetic-reports/formal/apalache-summary.json"
          if [ ! -f "$FILE" ]; then
            printf "%s\n" "::error::apalache-summary.json not found"
            exit 1
          fi
          ok=$(jq -r '.ok // ""' "$FILE" 2>/dev/null || printf "\n")
          ran=$(jq -r '.ran // false' "$FILE" 2>/dev/null || printf "false\n")
          if [ "$ran" != "true" ]; then
            printf "%s\n" "::error::Apalache did not run; cannot enforce"
            exit 1
          fi
          if [ "$ok" != "true" ]; then
            ec=$(jq -r '.errorCount // 0' "$FILE" 2>/dev/null || printf "0\n")
            printf "%s\n" "::error::Apalache not ok (errors=$ec)"
            exit 1
          fi

  verify-kani:
    name: verify:kani (presence)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'kani'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: .cache/tools/kani
          key: ${{ runner.os }}-kani-${{ env.KANI_VERSION }}
      - name: Install Kani (prebuilt)
        run: |
          set -euo pipefail
          TOOL_DIR="$PWD/.cache/tools/kani"
          mkdir -p "$TOOL_DIR"
          if [ ! -x "$TOOL_DIR/bin/kani-driver" ]; then
            curl -L -sS -o /tmp/kani.tar.gz "https://github.com/model-checking/kani/releases/download/kani-${KANI_VERSION}/kani-${KANI_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
            tar -xzf /tmp/kani.tar.gz -C "$TOOL_DIR" --strip-components=1
          fi
          export PATH="$TOOL_DIR/bin:$PATH"
          echo "$TOOL_DIR/bin" >> "$GITHUB_PATH"
          kani-driver --version || true
      - name: Kani presence (non-blocking)
        run: node scripts/formal/verify-kani.mjs || true
      - name: Upload Kani summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-kani
          path: artifacts/hermetic-reports/formal/kani-summary.json

  verify-spin:
    name: verify:spin (Promela)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'spin'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Install SPIN + gcc
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y spin gcc
          spin -V || true
          gcc --version || true
      - name: Run verify:spin (sample)
        run: node scripts/formal/verify-spin.mjs --file spec/spin/sample.pml --ltl p_done || true
      - name: Upload SPIN summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-spin
          path: artifacts/hermetic-reports/formal/spin-summary.json

  verify-csp:
    name: verify:csp (cspx)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'csp'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Setup Rust toolchain (for cspx)
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo (cspx)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin/cspx
          key: ${{ runner.os }}-cspx-${{ env.CSPX_REF }}
      - name: Install cspx (pinned)
        run: |
          set -euo pipefail
          # Persist for subsequent steps as well (not just this shell).
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.cargo/bin:$PATH"
          if ! command -v cspx >/dev/null 2>&1; then
            cargo install --git "$CSPX_REPO" --rev "$CSPX_REF" --locked cspx
          elif ! cspx typecheck --help | grep -q -- '--summary-json'; then
            cargo install --git "$CSPX_REPO" --rev "$CSPX_REF" --locked --force cspx
          fi
          cspx --version || true
          cspx typecheck --help | grep -q -- '--summary-json'
      - name: Run verify:csp (cspx, sample)
        run: node scripts/formal/verify-csp.mjs --file spec/csp/cspx-smoke.cspm --mode typecheck || true
      - name: Upload CSP reports (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-csp
          path: |
            artifacts/hermetic-reports/formal/csp-summary.json
            artifacts/hermetic-reports/formal/cspx-result.json
          if-no-files-found: ignore

  verify-lean:
    name: verify:lean (Lean4)
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || (github.event_name == 'workflow_dispatch' && (inputs.target == 'all' || inputs.target == 'lean'))
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
      - name: Cache elan + lake (Lean4)
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            spec/lean/.lake
          key: ${{ runner.os }}-lean-${{ hashFiles('spec/lean/lean-toolchain', 'spec/lean/lakefile.lean', 'spec/lean/SpecLean.lean') }}
      - name: Install elan (Lean toolchain installer)
        run: |
          set -euo pipefail
          if [ ! -x "$HOME/.elan/bin/elan" ]; then
            curl -L -sS https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
          fi
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"
          elan --version || true
          lake --version || true
      - name: Run verify:lean (lake build, non-blocking)
        run: node scripts/formal/verify-lean.mjs --timeout 600000 || true
      - name: Upload Lean summary (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-reports-lean
          path: artifacts/hermetic-reports/formal/lean-summary.json

  formal-aggregate:
    name: Formal Reports Aggregate
    needs:
      - verify-conformance
      - verify-alloy
      - verify-tla
      - verify-smt
      - verify-apalache
      - verify-kani
      - verify-spin
      - verify-csp
      - verify-lean
    if: always() && ((github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork && contains(github.event.pull_request.labels.*.name, 'run-formal')) || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/formal-aggregate.yml
    permissions:
      contents: read
      actions: read
      issues: write
    with:
      source_run_id: ${{ github.run_id }}
      pr_number: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}
