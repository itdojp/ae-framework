name: Policy Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled, edited]
  pull_request_review:
    types: [submitted, edited, dismissed]
  workflow_run:
    workflows:
      - Verify Lite
      - Copilot Review Gate
      - Security Analysis
      - testing-ddd-scripts
      - Context Pack Quality Gate
      - Spec Validation
      - Full CI (Comprehensive Testing)
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to evaluate (manual run)'
        required: false
        type: number

concurrency:
  group: policy-gate-${{ github.event.pull_request.number || github.event.pull_request_review.pull_request.number || github.event.workflow_run.pull_requests[0].number || github.event.workflow_run.id || inputs.pr_number || github.ref }}
  # This workflow is triggered by both pull_request and workflow_run events.
  # Keeping in-progress runs prevents required-check deadlocks from cancelled runs.
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  policy-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'

      - name: Resolve automation config
        env:
          AE_AUTOMATION_PROFILE: ${{ vars.AE_AUTOMATION_PROFILE || '' }}
          AE_AUTOMATION_GLOBAL_DISABLE: ${{ vars.AE_AUTOMATION_GLOBAL_DISABLE || '' }}
          AE_COPILOT_AUTO_FIX: ${{ vars.AE_COPILOT_AUTO_FIX || '' }}
          AE_COPILOT_AUTO_FIX_SCOPE: ${{ vars.AE_COPILOT_AUTO_FIX_SCOPE || '' }}
          AE_COPILOT_AUTO_FIX_LABEL: ${{ vars.AE_COPILOT_AUTO_FIX_LABEL || '' }}
          AE_AUTO_MERGE: ${{ vars.AE_AUTO_MERGE || '' }}
          AE_AUTO_MERGE_MODE: ${{ vars.AE_AUTO_MERGE_MODE || '' }}
          AE_AUTO_MERGE_LABEL: ${{ vars.AE_AUTO_MERGE_LABEL || '' }}
          AE_AUTO_MERGE_REQUIRE_RISK_LOW: ${{ vars.AE_AUTO_MERGE_REQUIRE_RISK_LOW || '' }}
          AE_AUTO_MERGE_REQUIRE_CHANGE_PACKAGE: ${{ vars.AE_AUTO_MERGE_REQUIRE_CHANGE_PACKAGE || '' }}
          AE_AUTO_MERGE_CHANGE_PACKAGE_ALLOW_WARN: ${{ vars.AE_AUTO_MERGE_CHANGE_PACKAGE_ALLOW_WARN || '' }}
          AE_GH_THROTTLE_MS: ${{ vars.AE_GH_THROTTLE_MS || '' }}
          AE_GH_RETRY_MAX_ATTEMPTS: ${{ vars.AE_GH_RETRY_MAX_ATTEMPTS || '' }}
          AE_GH_RETRY_INITIAL_DELAY_MS: ${{ vars.AE_GH_RETRY_INITIAL_DELAY_MS || '' }}
          AE_GH_RETRY_MAX_DELAY_MS: ${{ vars.AE_GH_RETRY_MAX_DELAY_MS || '' }}
          AE_GH_RETRY_MULTIPLIER: ${{ vars.AE_GH_RETRY_MULTIPLIER || '' }}
          AE_GH_RETRY_JITTER_MS: ${{ vars.AE_GH_RETRY_JITTER_MS || '' }}
          AE_GH_RETRY_DEBUG: ${{ vars.AE_GH_RETRY_DEBUG || '' }}
          AE_REVIEW_TOPOLOGY: ${{ vars.AE_REVIEW_TOPOLOGY || '' }}
          AE_POLICY_MIN_HUMAN_APPROVALS: ${{ vars.AE_POLICY_MIN_HUMAN_APPROVALS || '' }}
          COPILOT_REVIEW_WAIT_MINUTES: ${{ vars.COPILOT_REVIEW_WAIT_MINUTES || '' }}
          COPILOT_REVIEW_MAX_ATTEMPTS: ${{ vars.COPILOT_REVIEW_MAX_ATTEMPTS || '' }}
        run: |
          node scripts/ci/lib/automation-config.mjs --format github-env >> "$GITHUB_ENV"
          node scripts/ci/lib/automation-config.mjs --format summary >> "$GITHUB_STEP_SUMMARY"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

      - name: Resolve PR number
        id: pr
        shell: bash
        run: |
          set -euo pipefail
          PR_NUMBER="${{ github.event.pull_request.number || github.event.pull_request_review.pull_request.number || inputs.pr_number || '' }}"
          if [ -z "${PR_NUMBER}" ] && [ "${{ github.event_name }}" = "workflow_run" ]; then
            PR_NUMBER="$(jq -r '.workflow_run.pull_requests[0].number // ""' "$GITHUB_EVENT_PATH")"
          fi
          if [ -z "${PR_NUMBER}" ]; then
            printf '%s\n' 'skip=true' >> "$GITHUB_OUTPUT"
            printf '%s\n' 'pr_number=' >> "$GITHUB_OUTPUT"
            printf '%s\n' 'Policy Gate skipped: no PR context for this event.' >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          printf '%s\n' "skip=false" >> "$GITHUB_OUTPUT"
          printf '%s\n' "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Run risk labeler
        if: ${{ steps.pr.outputs.skip != 'true' && github.event_name != 'workflow_run' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: node scripts/ci/risk-labeler.mjs

      - name: Evaluate policy gate
        if: ${{ steps.pr.outputs.skip != 'true' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: node scripts/ci/policy-gate.mjs

      - name: Upload policy artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-gate-artifacts
          path: |
            artifacts/ci/risk-labeler-summary.json
            artifacts/ci/risk-labeler-summary.md
            artifacts/ci/policy-gate-summary.json
            artifacts/ci/policy-gate-summary.md
          if-no-files-found: warn
