{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ae-framework/schema/change-package.schema.json",
  "title": "Change Package",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "generatedAt",
    "policyPath",
    "source",
    "intent",
    "scope",
    "risk",
    "evidence",
    "reproducibility",
    "rolloutPlan",
    "monitoringPlan",
    "exceptions"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "change-package/v1"
    },
    "generatedAt": {
      "type": "string",
      "format": "date-time"
    },
    "policyPath": {
      "type": "string",
      "minLength": 1
    },
    "source": {
      "$ref": "#/$defs/source"
    },
    "intent": {
      "$ref": "#/$defs/intent"
    },
    "scope": {
      "$ref": "#/$defs/scope"
    },
    "risk": {
      "$ref": "#/$defs/risk"
    },
    "evidence": {
      "$ref": "#/$defs/evidence"
    },
    "reproducibility": {
      "$ref": "#/$defs/reproducibility"
    },
    "rolloutPlan": {
      "$ref": "#/$defs/rolloutPlan"
    },
    "monitoringPlan": {
      "$ref": "#/$defs/monitoringPlan"
    },
    "exceptions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/exception"
      }
    }
  },
  "$defs": {
    "source": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "repository",
        "prNumber",
        "baseRef",
        "headRef"
      ],
      "properties": {
        "repository": {
          "type": [
            "string",
            "null"
          ],
          "minLength": 1
        },
        "prNumber": {
          "type": [
            "integer",
            "null"
          ],
          "minimum": 1
        },
        "baseRef": {
          "type": "string",
          "minLength": 1
        },
        "headRef": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "intent": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "summary"
      ],
      "properties": {
        "summary": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "changedFiles",
        "changedFileCount",
        "areas"
      ],
      "properties": {
        "changedFiles": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "changedFileCount": {
          "type": "integer",
          "minimum": 0
        },
        "areas": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      }
    },
    "forceTrigger": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "condition",
        "ruleId",
        "matchedFiles"
      ],
      "properties": {
        "condition": {
          "type": "string",
          "minLength": 1
        },
        "ruleId": {
          "type": "string",
          "minLength": 1
        },
        "matchedFiles": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      }
    },
    "risk": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "selected",
        "inferred",
        "isHighRisk",
        "requiredLabels",
        "missingRequiredLabels",
        "rationale"
      ],
      "properties": {
        "selected": {
          "type": "string",
          "minLength": 1
        },
        "inferred": {
          "type": "string",
          "minLength": 1
        },
        "isHighRisk": {
          "type": "boolean"
        },
        "requiredLabels": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "missingRequiredLabels": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "rationale": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "highRiskPathMatches",
            "forceHighRiskTriggers"
          ],
          "properties": {
            "highRiskPathMatches": {
              "type": "array",
              "items": {
                "type": "string",
                "minLength": 1
              },
              "uniqueItems": true
            },
            "forceHighRiskTriggers": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/forceTrigger"
              }
            }
          }
        }
      }
    },
    "evidenceItem": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "path",
        "description",
        "present"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        },
        "path": {
          "type": "string",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "minLength": 1
        },
        "present": {
          "type": "boolean"
        }
      }
    },
    "evidence": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "artifactRoot",
        "items",
        "presentCount",
        "missingCount"
      ],
      "properties": {
        "artifactRoot": {
          "type": "string",
          "minLength": 1
        },
        "items": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/evidenceItem"
          }
        },
        "presentCount": {
          "type": "integer",
          "minimum": 0
        },
        "missingCount": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "reproducibility": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "commands"
      ],
      "properties": {
        "commands": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true,
          "minItems": 1
        }
      }
    },
    "rolloutPlan": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "strategy",
        "references",
        "notes"
      ],
      "properties": {
        "strategy": {
          "type": "string",
          "minLength": 1
        },
        "references": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "notes": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "monitoringPlan": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "signals",
        "alerts"
      ],
      "properties": {
        "signals": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "alerts": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      }
    },
    "exception": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "code",
        "message"
      ],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 1
        },
        "message": {
          "type": "string",
          "minLength": 1
        }
      }
    }
  }
}
